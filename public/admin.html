<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Atlas â€” Admin</title>
  <style>
    :root{ --bg:#0b0b0c; --card:#151518; --txt:#f2f2f3; --muted:#9aa0a6; --accent:#7c3aed; --ok:#2da44e; --err:#d1242f; --br:#2a2a2e; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--txt); }
    header{ display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--br); position:sticky; top:0; background: rgba(10,10,12,0.8); backdrop-filter: blur(6px); }
    a{ color:var(--accent); text-decoration:none; }
    .container{ max-width: 1100px; margin: 0 auto; padding: 16px; }
    .card{ background:var(--card); border: 1px solid var(--br); border-radius: 12px; padding: 16px; }
    .row{ display:grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px){ .row{ grid-template-columns: 2fr 1fr; } }
    .btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:8px; border:1px solid var(--br); background:#1e1e22; color:var(--txt); cursor:pointer; }
    .btn.primary{ background: var(--accent); border-color: #5525c9; }
    .btn.ok{ background: var(--ok); border-color: #1e7d39; }
    .btn.err{ background: var(--err); border-color: #85161d; }
    .btn:disabled{ opacity: 0.6; cursor: not-allowed; }
    .table{ width:100%; border-collapse: collapse; }
    .table th, .table td{ border-bottom:1px solid var(--br); padding:8px; text-align:left; }
    .badge{ display:inline-block; padding:2px 6px; border-radius:10px; font-size:11px; border:1px solid var(--br); color:var(--muted); }
    .muted{ color:var(--muted); }
    .stack{ display:flex; flex-direction:column; gap:12px; }
    .flex{ display:flex; gap:8px; align-items:center; }
    .right{ margin-left:auto; }
    .hidden{ display:none; }
    .note{ font-size: 13px; color: var(--muted); }
    input, textarea{ background:#1a1a1e; color:var(--txt); border:1px solid var(--br); border-radius:8px; padding:8px; }
  </style>
</head>
<body>
  <header>
    <div class="flex">
      <a href="./index.html" class="flex" style="align-items:center; gap:8px; color:var(--txt)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <strong>AI Atlas Admin</strong>
      </a>
    </div>
    <div id="user-info" class="flex"></div>
  </header>

  <div class="container">
    <div id="auth-gate" class="card">
      <h2>Admin Access</h2>
      <p class="muted">Sign in and ensure your account has the admin role. Contact an existing admin to grant access.</p>
      <div class="flex" style="margin-top:12px">
        <button id="signin-google" class="btn primary">Sign in with Google</button>
        <button id="signout" class="btn hidden">Sign out</button>
      </div>
      <p id="auth-msg" class="note" style="margin-top:8px"></p>
    </div>

    <div id="admin-panels" class="row hidden" style="margin-top:16px">
      <div class="stack">
        <div class="card">
          <div class="flex" style="justify-content:space-between">
            <h3>Pending Approvals</h3>
            <div class="flex">
              <button id="refresh-pending" class="btn">Refresh</button>
            </div>
          </div>
          <div id="pending-empty" class="muted hidden">No pending tools.</div>
          <table class="table" id="pending-table">
            <thead>
              <tr><th>Name</th><th>Domain</th><th>Link</th><th>Created</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="card">
          <h3>Quick Actions</h3>
          <p class="note">More admin features coming soon. This MVP supports listing and approving/rejecting pending tools.</p>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase web SDKs
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, getIdTokenResult } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDKpMZ_ik9LdcJxg3tKre-MAApV0BpI0Wo",
      authDomain: "ai-domain-atlas.firebaseapp.com",
      projectId: "ai-domain-atlas",
      storageBucket: "ai-domain-atlas.firebasestorage.app",
      messagingSenderId: "656158450742",
      appId: "1:656158450742:web:928b64678b22c12fe22497",
      measurementId: "G-ES11CRRDP6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const authGate = document.getElementById('auth-gate');
    const adminPanels = document.getElementById('admin-panels');
    const authMsg = document.getElementById('auth-msg');
    const signInBtn = document.getElementById('signin-google');
    const signOutBtn = document.getElementById('signout');
    const userInfo = document.getElementById('user-info');

    async function getAdminToken(){
      const user = auth.currentUser;
      if(!user) return null;
      const res = await getIdTokenResult(user, true);
      const isAdmin = !!res.claims.admin;
      return { token: await user.getIdToken(), isAdmin, email: user.email||'', uid: user.uid };
    }

    function setSignedOut(){
      userInfo.innerHTML = '';
      signOutBtn.classList.add('hidden');
      signInBtn.classList.remove('hidden');
      authPanels(false);
      authMsg.textContent = 'Not signed in.';
    }
    function authPanels(show){
      if(show){
        adminPanels.classList.remove('hidden');
      }else{
        adminPanels.classList.add('hidden');
      }
    }

    async function fetchPending(){
      const at = await getAdminToken();
      if(!at || !at.isAdmin){ authMsg.textContent = 'Admin role required. Ask an admin to grant access.'; authPanels(false); return; }
      const headers = { 'Authorization': 'Bearer ' + at.token };
      const res = await fetch('/.netlify/functions/admin-list-pending?limit=100&status=pending',{ headers });
      if(!res.ok){ throw new Error('Failed to load pending: ' + res.status); }
      return res.json();
    }

    async function approveOrReject(id, action, reason){
      const at = await getAdminToken();
      const headers = { 'Authorization': 'Bearer ' + at.token, 'Content-Type':'application/json' };
      const body = JSON.stringify({ id, action, reason });
      const res = await fetch('/.netlify/functions/admin-review', { method:'POST', headers, body });
      if(!res.ok){ const t = await res.text(); throw new Error('Failed: ' + res.status + ' ' + t); }
      return res.json();
    }

    function renderPending(items){
      const tbody = document.querySelector('#pending-table tbody');
      const empty = document.getElementById('pending-empty');
      tbody.innerHTML = '';
      if(!items || items.length === 0){ empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden');
      for(const x of items){
        const tr = document.createElement('tr');
        const created = x.createdAt ? new Date(x.createdAt).toLocaleString() : '';
        tr.innerHTML = `
          <td>${escapeHtml(x.name||'')}</td>
          <td><span class="badge">${escapeHtml(x.domainName||x.domainSlug||'')}</span></td>
          <td>${x.link ? `<a href="${escapeHtml(x.link)}" target="_blank">open</a>` : ''}</td>
          <td class="muted">${created}</td>
          <td>
            <div class="flex">
              <button class="btn ok" data-action="approve">Approve</button>
              <button class="btn err" data-action="reject">Reject</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
        const [approveBtn, rejectBtn] = tr.querySelectorAll('button');
        approveBtn.addEventListener('click', async () => {
          approveBtn.disabled = true; rejectBtn.disabled = true;
          try { await approveOrReject(x.id, 'approve'); tr.remove(); } catch(e){ alert(e.message||e); } finally { approveBtn.disabled = false; rejectBtn.disabled = false; }
        });
        rejectBtn.addEventListener('click', async () => {
          const reason = prompt('Reason for rejection (optional):') || '';
          rejectBtn.disabled = true; approveBtn.disabled = true;
          try { await approveOrReject(x.id, 'reject', reason); tr.remove(); } catch(e){ alert(e.message||e); } finally { rejectBtn.disabled = false; approveBtn.disabled = false; }
        });
      }
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    onAuthStateChanged(auth, async (user) => {
      if(!user){ setSignedOut(); return; }
      userInfo.textContent = user.email || user.uid;
      signInBtn.classList.add('hidden');
      signOutBtn.classList.remove('hidden');
      const at = await getAdminToken();
      if(at && at.isAdmin){ authMsg.textContent = 'Admin access granted.'; authPanels(true); const data = await fetchPending(); renderPending(data.items||[]); }
      else { authMsg.textContent = 'Signed in but missing admin role. Ask an admin to grant access.'; authPanels(false); }
    });

    document.getElementById('refresh-pending').addEventListener('click', async ()=>{
      try { const data = await fetchPending(); renderPending(data.items||[]); } catch(e){ alert(e.message||e); }
    });

    signInBtn.addEventListener('click', async ()=>{
      try { await signInWithPopup(auth, provider); } catch(e){ alert(e.message||e); }
    });
    signOutBtn.addEventListener('click', async ()=>{
      try { await signOut(auth); } catch(e){ alert(e.message||e); }
    });
  </script>
</body>
</html>
