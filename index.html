<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ToolVerse</title>
    <!-- Social preview metadata -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="AI ToolVerse">
    <meta property="og:title" content="AI ToolVerse – Curated AI tools by category">
    <meta property="og:description" content="Discover the best AI tools across categories like chat, image, code, research, and more.">
    <meta property="og:image" content="./images/tool_verse_new_logo_upd_141025_upd.PNG?v=20251013c">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="AI ToolVerse – Curated AI tools by category">
    <meta name="twitter:description" content="Discover the best AI tools across categories like chat, image, code, research, and more.">
    <meta name="twitter:image" content="./images/tool_verse_new_logo_upd_141025_upd.PNG?v=20251013c">
    <!-- Favicons -->
    <link rel="icon" type="image/png" href="./images/tool_verse_new_logo_upd_141025_upd.PNG?v=20251013c">
    <!-- Mobile address bar theming -->
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0b0b0c">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Fuse.js for fuzzy search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
    
    <!-- Custom Stylesheet -->
    <style>
        html, body, #app {
            height: 100% !important;
            min-height: 100vh !important;
        }
        html, body {
            background: transparent !important;
        }
        .bg-card,
        .domain-card,
        .feature-card {
            background-color: rgba(255,255,255,0.75) !important;
        }
        html.dark .bg-card,
        html.dark .domain-card,
        html.dark .feature-card {
            background-color: rgba(24,24,27,0.75) !important;
        }
        /* Dedicated background layer ensures full coverage across mobile browsers */
        #background-video {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            object-fit: cover;
            z-index: 0;
            pointer-events: none;
            opacity: 0; /* fade in when ready */
            transition: opacity 600ms ease;
            background: transparent;
        }
        #background-image {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            background-image: url('./images/Gemini_Generated_Image_c098t3c098t3c098.png?v=20251014a');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: -1; /* keep behind the video; used as a fallback */
            pointer-events: none;
        }
        #background-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            background: rgba(255,255,255,0.50); /* increased opacity */
            z-index: 1; /* above background image, below app */
            pointer-events: none;
        }
        /* Filter backdrop to prevent underlying content from showing/clicking */
        #filter-backdrop {
            position: fixed; inset: 0; z-index: 999; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(2px); pointer-events: none; /* disabled by default to avoid stray tap blocks */
        }
        html.dark #filter-backdrop {
            background: rgba(0, 0, 0, 0.5);
        }
        /* Make filter menu more opaque and above contents */
    #filter-menu { z-index: 1000; background: rgba(255,255,255,0.97) !important; overflow-y: auto; max-height: 60vh; overscroll-behavior: contain; pointer-events: auto; touch-action: pan-y; -webkit-overflow-scrolling: touch; color: var(--text-primary); }
    html.dark #filter-menu { background: rgba(24,24,27,0.97) !important; }
    /* Improve readability in dark mode */
    html.dark #filter-menu, html.dark #filter-menu button { color: var(--text-primary) !important; }
    #filter-menu button { color: inherit; }
    /* Note: positioning is handled by JavaScript for mobile/desktop compatibility */
        html.dark #background-overlay {
            background: rgba(30,41,59,0.50);
        }
        /* Mobile: avoid iOS background-attachment jank */
        @media (max-width: 768px) {
            body { background-attachment: scroll !important; }
        }
        /* ...existing code... */
        /* Pricing group animations */
    .pricing-group { transition: height 0.3s ease, opacity 0.25s ease, transform 0.25s ease, padding 0.25s ease, margin 0.25s ease, border-color 0.25s ease; align-self: start; }
        .pricing-group.group-empty { height: 0 !important; opacity: 0 !important; transform: scale(.97); }
        .pricing-group.group-filled { opacity: 1; }
        @media (prefers-reduced-motion: reduce) {
            .pricing-group { transition: none; }
        }
    :root {
        --bg-primary: transparent; /* Let the image show through */
        --bg-primary-translucent: rgba(244, 244, 245, 0.9); /* Keep for other elements if needed */
        --bg-secondary: #e4e4e7;
        --bg-card: #ffffff;
        --header-offset: 80px; /* default header offset for fixed header */
        --text-primary: #18181b;
        --text-secondary: #52525b;
        --text-muted: #71717a;
        --border-color: #e4e4e7;
        --header-bg: linear-gradient(to right, rgba(250, 245, 255, 0.8), rgba(255, 255, 255, 0.8));
    --header-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.07);
    /* Additional bottom drop shadow for header depth */
    --header-bottom-shadow: 0 12px 20px -12px rgba(0, 0, 0, 0.28);
        --scrollbar-track: #e4e4e7;
        --scrollbar-thumb: #a1a1aa;
        --scrollbar-thumb-hover: #71717a;
        --tag-bg: #e4e4e7;
        --tag-text: #3f3f46;
    }

    html.dark {
        --bg-primary: transparent; /* Let the image show through */
        --bg-primary-translucent: rgba(10, 10, 10, 0.9); /* Keep for other elements if needed */
        --bg-secondary: #1a1a1a;
        --bg-card: #18181b;
        --text-primary: #f5f5f5;
        --text-secondary: #a1a1aa;
        --text-muted: #71717a;
        --border-color: #27272a;
        --header-bg: linear-gradient(to right, rgba(30, 27, 75, 0.8), rgba(17, 17, 17, 0.8));
    --header-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.2);
    --header-bottom-shadow: 0 14px 24px -14px rgba(0, 0, 0, 0.55);
        --scrollbar-track: #1a1a1a;
        --scrollbar-thumb: #4a4a4a;
        --scrollbar-thumb-hover: #5a5a5a;
        --tag-bg: #3f3f46;
        --tag-text: #d4d4d8;
    }

        #app {
            transition: background-color 0.3s ease;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }

        .card-hover-effect {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card-hover-effect:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        html.dark .card-hover-effect:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2), 0 0 15px rgba(76, 29, 149, 0.3);
        }

        header { 
            background: var(--header-bg); 
            border-color: var(--border-color);
            /* Stack a stronger bottom shadow for separation from hero */
            box-shadow: var(--header-shadow), var(--header-bottom-shadow) !important;
            padding-top: env(safe-area-inset-top);
            position: fixed; /* keep visible while scrolling */
            top: 0; left: 0; right: 0; width: 100%; z-index: 50;
        }
        #home-link { color: var(--text-primary); }
        nav a { color: var(--text-secondary); }
        nav a:hover { background-color: var(--bg-secondary); color: var(--text-primary); }
        #theme-toggle { color: var(--text-secondary); }
        #theme-toggle:hover { background-color: var(--bg-secondary); }
    #filter-button { cursor: pointer; }
        footer { background-color: var(--bg-secondary); border-top-color: var(--border-color); }
        footer p { color: var(--text-muted); }
        #search-bar { background-color: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); }
        #search-bar::placeholder { color: var(--text-muted); }
    main { padding-top: var(--header-offset); }
        /* Ensure search+filter control always sits above nearby content (e.g., carousels) on mobile */
        #search-filter-unit { position: relative; z-index: 100; }
        #filter-button { position: relative; z-index: 101; }

        .domain-card, .feature-card {
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }
        .domain-card { align-items: center; text-align: center; }

        .tool-list-item {
            background-color: var(--bg-card);
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            cursor: pointer;
            border: 1px solid var(--border-color);
            transition: background 0.2s, color 0.2s;
            min-width: 0;
            position: relative;
        }
        .tool-desc-line {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: clamp(180px, 32vw, 340px);
            display: block;
            min-width: 0;
            line-height: 1.5;
            margin-bottom: 0.25rem;
            padding-right: 0.5rem;
            background: transparent;
        }
        .tool-desc-full {
            white-space: normal;
            word-break: break-word;
            max-width: clamp(180px, 32vw, 340px);
            display: block;
            background: transparent;
            margin-bottom: 0.25rem;
            padding-right: 0.5rem;
        }
        #theme-toggle, .open-tool-btn, .tool-list-item a {
            transition: background 0.2s, color 0.2s;
        }
        .open-tool-btn {
            color: var(--text-primary);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        .dark .open-tool-btn {
            color: #f3f4f6;
            background: #23272f;
            border: 1px solid #444;
        }
        .tool-list-item a {
            text-decoration: none;
            z-index: 1;
        }
        .tool-list-item a:focus, .tool-list-item a:hover {
            outline: 2px solid #a78bfa;
        }
        @media (min-width: 768px) { .tool-list-item { flex-direction: row; align-items: center; } }
        @media (min-width: 768px) {
            .tool-list-item {
                flex-direction: row;
                align-items: flex-start;
            }
            .tool-desc-line, .tool-desc-full {
                max-width: 340px;
            }
        }

        .tag { background-color: var(--tag-bg); color: var(--tag-text); }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-muted { color: var(--text-muted); }

    .prose { color: var(--text-secondary); }
        .prose h1, .prose h2, .prose h5, .prose h6 { color: var(--text-primary); }
    /* Footer styles (light by default, with dark-mode overrides) */
    /* Medium-light footer */
    .site-footer { background-color: #e9efff; color: #0f172a; }
    .site-footer .footer-link { color: #334155; }
    .site-footer .footer-link:hover { color: #0f172a; text-decoration: underline; }
    .site-footer .footer-icon { color: #475569; }
    .site-footer .footer-icon:hover { color: #1f2937; }
    .site-footer .footer-input { background: #ffffff; border: 1px solid #e5e7eb; color: #1f2937; }
    .site-footer .footer-input::placeholder { color: #6b7280; }
    .site-footer .footer-button { background: #4f46e5; color: white; }
    .site-footer .footer-button:hover { background: #4338ca; }
    .site-footer hr { border-color: rgba(0,0,0,0.08); }
    /* Slight top padding so top sections never sit under header on any page */
    #content-area { padding-top: 3rem; }

        .tool-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .tool-details.expanded {
            max-height: 1000px;
        }
        .tool-details .details-content {
            padding: 0 1.5rem 1.5rem 1.5rem;
            background-color: transparent;
            border-top: 1px solid var(--border-color);
            margin-top: 1rem;
        }
        .details-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin-top: 1rem; }
        @media (min-width: 640px) { .details-grid { grid-template-columns: 1fr 1fr; } }

        .pros-cons-list { list-style-type: none; padding-left: 0; margin-top: 0.5rem; }
        .pros-cons-list li { position: relative; padding-left: 1.75rem; margin-bottom: 0.5rem; color: var(--text-secondary); }
        .pros-cons-list li::before {
            content: ''; position: absolute; left: 0; top: 5px; width: 1rem; height: 1rem;
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }
        .pros .pros-cons-list li::before { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2334D399'%3E%3Cpath fill-rule='evenodd' d='M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z' clip-rule='evenodd' /%3E%3C/svg%3E"); }
        .cons .pros-cons-list li::before { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%23F87171'%3E%3Cpath fill-rule='evenodd' d='M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z' clip-rule='evenodd' /%3E%3C/svg%3E"); }
        .details-grid h6 { display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; font-weight: 600; color: var(--text-primary); }

        /* Auth Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--bg-card);
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 400px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }

        /* New search styles */
        .search-wrapper { max-width: 900px; margin: 0 auto 1.5rem; display:flex; gap:8px; align-items:center; }
        .search-input { flex:1; padding:0.75rem 1rem; border-radius:0.75rem; border:1px solid var(--border-color); background:var(--bg-card); color:var(--text-primary); }
        .search-clear { background:transparent; border:1px solid var(--border-color); padding:0.5rem 0.75rem; border-radius:0.5rem; color:var(--text-secondary); }
    /* Fluid, auto-fitting search grid (smaller tiles, more spacing) */
    .search-results { margin-top:1rem; display:grid; gap:14px; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); }
    @media(min-width:640px) { .search-results { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); } }
    @media(min-width:1024px) { .search-results { grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); } }
        .tile-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 0.6rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            /* Let height be content-driven for compact tiles */
            text-align: center;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .tile-card:hover { transform: translateY(-4px); box-shadow: 0 8px 18px rgba(0,0,0,.12); }
        html.dark .tile-card:hover { box-shadow: 0 8px 18px rgba(0,0,0,.25), 0 0 12px rgba(76, 29, 149, 0.25); }
    .tile-title { font-weight: 700; color: var(--text-primary); font-size: 0.9rem; line-height: 1.2; display:-webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow:hidden; }
    .tile-desc { color: var(--text-secondary); font-size: 0.8rem; line-height: 1.25; display:-webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow:hidden; min-height: 2.2em; }
    .tile-blurb { color: var(--text-primary); font-weight: 700; font-size: 0.8rem; line-height: 1.25; display:-webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow:hidden; min-height: 2.2em; background: rgba(124, 58, 237, 0.10); border: 1px solid rgba(124, 58, 237, 0.25); padding: 4px 8px; border-radius: 9999px; }
        .tile-tags { display:flex; gap:6px; flex-wrap: wrap; justify-content: center; }
        .tile-actions { display:flex; gap:8px; align-items:center; justify-content:center; }
        .pager-btn { border:1px solid var(--border-color); background: var(--bg-card); color: var(--text-primary); padding: .35rem .6rem; border-radius:.5rem; }
        .pager-btn[disabled] { opacity:.5; cursor: not-allowed; }

    /* Utility: hide scrollbar (kept if needed elsewhere) */
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }

        /* Tool Details Modal Styles */
        #tool-details-modal-content {
            max-width: 600px;
        }
        /* Mobile menu styles */
        .mobile-menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); display: none; z-index: 60; }
        .mobile-menu { position: fixed; top: 0; right: 0; height: 100vh; width: 85vw; max-width: 360px; background: var(--bg-primary-translucent); border-left: 1px solid var(--border-color); box-shadow: -6px 0 24px rgba(0,0,0,0.2); transform: translateX(100%); transition: transform .25s ease; z-index: 70; }
        html.dark .mobile-menu { background: rgba(24,24,27,0.92); }
        .mobile-menu.open { transform: translateX(0); }
        .mobile-menu-overlay.show { display:block; }
        .no-scroll { overflow: hidden; }
    </style>
    
</head>
<body class="antialiased">
    <!-- Background video layer (will fade in when ready). To override source via URL, add ?bgmp4=encodedURL -->
    <video id="background-video" autoplay muted loop playsinline preload="auto" aria-hidden="true">
        <!-- Default source path; update public/videos/background_anim.mp4 when adding the actual file -->
        <source id="bg-video-source" src="./images/background_anim.mp4" type="video/mp4">
    </video>
    <div id="background-image"></div>
    <div id="background-overlay"></div>
    <div id="app" style="min-height:100vh; display:flex; flex-direction:column; position:relative; z-index:2;">
        <!-- Header -->
    <a href="#content-area" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 bg-white dark:bg-gray-800 text-sm px-3 py-2 rounded z-[100]">Skip to content</a>
    <header id="site-header" class="backdrop-blur-lg border-b bg-gradient-to-r from-white/70 via-white/40 to-white/70 dark:from-slate-900/70 dark:via-slate-900/50 dark:to-slate-900/70 shadow-sm">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-[68px] md:h-[84px]">
                    <div class="flex items-center">
                        <a href="#" id="home-link" class="flex items-center" title="AI ToolVerse">
                            <img src="./images/tool_verse_new_logo_upd_141025_upd.PNG?v=20251013c" alt="AI ToolVerse" class="h-[3.51rem] md:h-[4rem] lg:h-[5rem] w-auto object-contain drop-shadow-sm" loading="lazy" decoding="async" fetchpriority="high" onerror="this.onerror=null; this.src='./images/tool_verse_new_logo_upd_new_vector.png?v=20251011v2';">
                        </a>
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- Mobile hamburger -->
                        <button id="mobile-menu-btn" aria-label="Open menu" aria-haspopup="true" aria-expanded="false" aria-controls="mobile-menu-panel" class="md:hidden p-2 rounded-md border border-color bg-card hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                        </button>
                        <button id="theme-toggle" aria-label="Toggle dark mode" class="p-2 rounded-full border border-color bg-card hover:bg-secondary transition flex items-center justify-center mr-2">
                            <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                            <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 12.122l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414zM17 13a1 1 0 100 2h1a1 1 0 100-2h-1z" clip-rule="evenodd"></path></svg>
                        </button>
                        <div class="hidden md:block">
                            <div id="main-nav" class="ml-6 flex items-baseline space-x-4">
                                <a href="#" id="domains-link" class="px-3 py-2 rounded-md text-base font-medium">Domains</a>
                                <a href="#" id="submit-link" class="px-3 py-2 rounded-md text-base font-medium">Submit a Tool</a>
                                <a href="#" id="about-link" class="px-3 py-2 rounded-md text-base font-medium">About</a>
                            </div>
                        </div>
                        <div id="auth-container" class="flex items-center ml-4">
                            <!-- Auth state will be rendered here -->
                        </div>
                    </div>
                </div>
            </nav>
        </header>

    <!-- Spacer to offset fixed header height -->
    <div id="header-spacer" aria-hidden="true"></div>

    <!-- Mobile menu panel -->
        <div id="mobile-menu-overlay" class="mobile-menu-overlay" tabindex="-1" aria-hidden="true"></div>
        <aside id="mobile-menu-panel" class="mobile-menu" role="dialog" aria-modal="true" aria-labelledby="mobile-menu-title">
            <div class="p-4 flex items-center justify-between">
                <h2 id="mobile-menu-title" class="text-lg font-semibold text-primary">Menu</h2>
                <button id="mobile-menu-close" class="p-2 rounded-md border border-color bg-card hover:bg-secondary" aria-label="Close menu">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" stroke="currentColor" fill="none"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
            <nav class="px-4 pb-6 flex flex-col gap-2">
                <a href="#" id="m-domains-link" class="px-3 py-2 rounded-md text-base font-medium">Domains</a>
                <a href="#" id="m-submit-link" class="px-3 py-2 rounded-md text-base font-medium">Submit a Tool</a>
                <a href="#" id="m-about-link" class="px-3 py-2 rounded-md text-base font-medium">About</a>
            </nav>
            <div class="px-4 pb-6 border-t border-color">
                <div id="m-auth-container" class="pt-4"></div>
            </div>
        </aside>

        <!-- Policy Banner: GitHub-hosted tools exclusion -->
        <div id="policy-banner" class="hidden">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <div class="bg-card border border-dashed border-color rounded-lg p-3 flex items-start justify-between gap-3">
                    <p class="text-sm text-secondary">
                        Note: GitHub-hosted repo links are hidden by policy to keep the catalog focused. Exception: GitHub Copilot.
                    </p>
                    <button id="policy-banner-dismiss" class="text-sm text-secondary hover:text-primary px-2 py-1 rounded border border-transparent hover:border-color">Dismiss</button>
                </div>
            </div>
        </div>

        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
            <div id="content-area">
                 <div class="text-center text-secondary">Loading AI tools...</div>
            </div>
        </main>

    <footer class="site-footer" style="padding-bottom: env(safe-area-inset-bottom);">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-10">
                <!-- Brand & Disclosure -->
                <div class="md:col-span-5">
                    <div class="flex items-center gap-3 mb-4">
                        <img src="./images/tool_verse_new_logo_upd_141025_upd.PNG?v=20251013c" alt="AI ToolVerse" class="h-[2.73rem] w-auto" onerror="this.onerror=null; this.src='./images/tool_verse_new_logo_upd_new_vector.png?v=20251011v2';">
                        <span class="text-xl font-semibold">AI ToolVerse</span>
                    </div>
                    <p class="text-sm leading-6 opacity-90">
                        Editorial Note: We strive for accurate, helpful listings curated by humans. Some links may be affiliate links that help support the project—at no extra cost to you.
                    </p>
                </div>
                <!-- Categories -->
                <div class="md:col-span-2">
                    <h4 class="text-base font-semibold mb-3">Categories</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" class="footer-link">Productivity Tools</a></li>
                        <li><a href="#" class="footer-link">Image Generators</a></li>
                        <li><a href="#" class="footer-link">Text Generators</a></li>
                        <li><a href="#" class="footer-link">Video Tools</a></li>
                        <li><a href="#" class="footer-link">Art Generators</a></li>
                        <li><a href="#" class="footer-link">Audio Generators</a></li>
                        <li><a href="#" class="footer-link">All AI Tools</a></li>
                    </ul>
                </div>
                <!-- Resources -->
                <div class="md:col-span-3">
                    <h4 class="text-base font-semibold mb-3">Resources</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" class="footer-link">Best AI Art Generators</a></li>
                        <li><a href="#" class="footer-link">Best AI Image Generators</a></li>
                        <li><a href="#" class="footer-link">Best AI Chatbots</a></li>
                        <li><a href="#" class="footer-link">Best AI Text Generators</a></li>
                        <li><a href="#" class="footer-link">Best AI 3D Generators</a></li>
                        <li><a href="#" class="footer-link">All Resources</a></li>
                    </ul>
                </div>
                <!-- Company -->
                <div class="md:col-span-2">
                    <h4 class="text-base font-semibold mb-3">Company</h4>
                    <ul class="space-y-2 text-sm">
                        <li><a href="#" class="footer-link">Contact Us</a></li>
                        <li><a href="#" class="footer-link">Advertise</a></li>
                        <li><a href="#" class="footer-link">Submit a Tool</a></li>
                        <li><a href="#" class="footer-link">Request a Feature</a></li>
                        <li><a href="#" class="footer-link">Update a Tool</a></li>
                    </ul>
                    <div class="flex items-center gap-4 mt-4 opacity-80">
                        <!-- Simple social icons -->
                        <a href="#" aria-label="LinkedIn" class="footer-icon"> 
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M4.98 3.5C4.98 4.88 3.86 6 2.5 6S0 4.88 0 3.5 1.12 1 2.5 1s2.48 1.12 2.48 2.5zM.5 8h4V24h-4V8zm7.5 0h3.8v2.2h.05c.53-1 1.84-2.2 3.8-2.2 4.07 0 4.82 2.68 4.82 6.17V24h-4v-7.1c0-1.7-.03-3.9-2.38-3.9-2.38 0-2.75 1.86-2.75 3.78V24h-4V8z"/></svg>
                        </a>
                        <a href="#" aria-label="Twitter" class="footer-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M22.46 6c-.77.35-1.6.58-2.46.69a4.26 4.26 0 0 0 1.88-2.35 8.51 8.51 0 0 1-2.7 1.03 4.25 4.25 0 0 0-7.3 3.88 12.06 12.06 0 0 1-8.75-4.44 4.24 4.24 0 0 0 1.31 5.66 4.2 4.2 0 0 1-1.93-.53v.05a4.25 4.25 0 0 0 3.41 4.16 4.27 4.27 0 0 1-1.92.07 4.26 4.26 0 0 0 3.97 2.95A8.52 8.52 0 0 1 2 19.54 12.02 12.02 0 0 0 8.29 21c7.55 0 11.68-6.26 11.68-11.68 0-.18-.01-.36-.02-.54A8.35 8.35 0 0 0 22.46 6z"/></svg>
                        </a>
                        <a href="#" aria-label="YouTube" class="footer-icon">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M23.5 6.2s-.2-1.6-.8-2.2c-.8-.8-1.6-.8-2-1C17.9 2.5 12 2.5 12 2.5h0s-5.9 0-8.7.5c-.4.1-1.2.2-2 1-.6.6-.8 2.2-.8 2.2S0 8.1 0 10v1.9c0 1.9.2 3.8.2 3.8s.2 1.6.8 2.2c.8.8 1.8.8 2.2.9 1.6.2 6.8.5 8.8.5s8.7-.1 8.7-.1 1.2-.1 2-.9c.6-.6.8-2.2.8-2.2s.2-1.9.2-3.8V10c0-1.9-.2-3.8-.2-3.8zM9.5 14.6V7.9l6.3 3.3-6.3 3.4z"/></svg>
                        </a>
                        <a href="#" aria-label="Instagram" class="footer-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2C4.24 2 2 4.24 2 7v10c0 2.76 2.24 5 5 5h10c2.76 0 5-2.24 5-5V7c0-2.76-2.24-5-5-5H7zm10 2c1.65 0 3 1.35 3 3v10c0 1.65-1.35 3-3 3H7c-1.65 0-3-1.35-3-3V7c0-1.65 1.35-3 3-3h10zm-5 3.5A5.5 5.5 0 1 0 17.5 13 5.5 5.5 0 0 0 12 7.5zm0 2A3.5 3.5 0 1 1 8.5 13 3.5 3.5 0 0 1 12 9.5zm5.75-2.5a1 1 0 1 0 1 1 1 1 0 0 0-1-1z"/></svg>
                        </a>
                        <a href="#" aria-label="Facebook" class="footer-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M22 12a10 10 0 1 0-11.5 9.9v-7H7.9V12h2.6V9.7c0-2.6 1.5-4 3.8-4 1.1 0 2.2.2 2.2.2v2.4h-1.2c-1.2 0-1.6.7-1.6 1.5V12h2.7l-.4 2.9h-2.3v7A10 10 0 0 0 22 12z"/></svg>
                        </a>
                    </div>
                </div>
            </div>
            <!-- Newsletter Subscribe -->
            <div class="mt-8 rounded-2xl border border-white/10 bg-white/5 p-5 md:p-6">
                <div class="flex flex-col md:flex-row items-center gap-3 md:gap-4">
                    <div class="flex-1 min-w-0">
                        <h4 class="text-lg font-semibold">Stay in the loop</h4>
                        <p class="text-sm opacity-80">Get monthly updates on the best AI tools and open-source projects.</p>
                    </div>
                    <form id="footer-subscribe-form" novalidate class="flex w-full md:w-auto items-stretch gap-2">
                        <input id="footer-subscribe-email" type="email" required placeholder="you@example.com" class="footer-input rounded-md px-3 py-2 w-full md:w-72 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <button id="footer-subscribe-btn" type="submit" class="footer-button rounded-md px-4 py-2 font-semibold">Subscribe</button>
                    </form>
                </div>
                <p id="footer-subscribe-status" class="text-sm mt-2 opacity-90" aria-live="polite"></p>
            </div>
            <hr class="border-white/10 my-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-3 text-sm opacity-90">
                <p>&copy; 2025 AI ToolVerse. All rights reserved.</p>
                <p>
                    <a href="./CODE_OF_CONDUCT.md" class="footer-link">Code of Conduct</a>
                    <span class="mx-2">·</span>
                    <a href="#" class="footer-link">Privacy Policy</a>
                    <span class="mx-2">·</span>
                    <a href="#" class="footer-link">Terms of Service</a>
                </p>
            </div>
        </div>
    </footer>
    </div>
    
    <!-- Auth Modal -->
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-bold text-primary">Sign In</h2>
                <button id="close-modal-btn" class="text-secondary hover:text-primary">&times;</button>
            </div>
            <div id="modal-error" class="text-red-500 text-sm mb-4 hidden"></div>
            <form id="auth-form" class="space-y-4">
                <input type="email" id="email-input" placeholder="Email" class="w-full p-3 rounded-md bg-secondary border-color text-primary focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                <input type="password" id="password-input" placeholder="Password" class="w-full p-3 rounded-md bg-secondary border-color text-primary focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                <button type="submit" id="auth-submit-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition">Sign In</button>
            </form>
            <div class="text-center my-4 text-muted text-sm">OR</div>
            <button id="google-signin-btn" class="w-full bg-white dark:bg-gray-700 border border-color text-primary font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48" width="48px" height="48px"><path fill="#fbc02d" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12	s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20	s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#e53935" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039	l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4caf50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36	c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1565c0" d="M43.611,20.083L43.595,20L42,20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574	l6.19,5.238C42.012,35.846,44,30.138,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Sign In with Google
            </button>
            <p class="text-center text-sm text-muted mt-6">
                <span id="modal-prompt-text">Don't have an account?</span>
                <button id="modal-switch-btn" class="text-purple-600 hover:underline">Sign Up</button>
            </p>
        </div>
    </div>

    <!-- Tool Details Modal -->
    <div id="tool-details-modal" class="modal-overlay">
        <div id="tool-details-modal-content" class="modal-content">
            <!-- Content will be injected by JavaScript -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
    // --- THEME TOGGLE LOGIC ---
        function setupTheme() {
            const themeToggleBtn = document.getElementById('theme-toggle');
            const darkIcon = document.getElementById('theme-toggle-dark-icon');
            const lightIcon = document.getElementById('theme-toggle-light-icon');
            // Set initial state
            function updateThemeIcons() {
                const isDark = document.documentElement.classList.contains('dark');
                if (isDark) {
                    darkIcon.classList.add('hidden');
                    lightIcon.classList.remove('hidden');
                } else {
                    darkIcon.classList.remove('hidden');
                    lightIcon.classList.add('hidden');
                }
            }
            updateThemeIcons();
            themeToggleBtn.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                updateThemeIcons();
                // Optionally persist theme
                if (window.localStorage) {
                    localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                }
            });
            // On load, respect saved theme
            if (window.localStorage) {
                const saved = localStorage.getItem('theme');
                if (saved === 'dark') document.documentElement.classList.add('dark');
                else if (saved === 'light') document.documentElement.classList.remove('dark');
                updateThemeIcons();
            }
        }
        setupTheme();

        // Fixed header spacer adjuster
        (function headerSpacer(){
            const header = document.getElementById('site-header');
            const spacer = document.getElementById('header-spacer');
            function apply(){
                if (!header || !spacer) return;
                const h = header.getBoundingClientRect().height;
                const extra = 64; // even larger buffer so top sections never clip under header (all pages)
                const total = h + extra;
                spacer.style.height = total + 'px';
                try { document.documentElement.style.setProperty('--header-offset', total + 'px'); } catch {}
            }
            window.addEventListener('load', apply);
            window.addEventListener('resize', apply);
            const ro = (window.ResizeObserver) ? new ResizeObserver(apply) : null;
            if (ro && header) ro.observe(header);
            apply();
        })();

        // --- MOBILE MENU LOGIC ---
        (function mobileMenu(){
            const btn = document.getElementById('mobile-menu-btn');
            const panel = document.getElementById('mobile-menu-panel');
            const overlay = document.getElementById('mobile-menu-overlay');
            const closeBtn = document.getElementById('mobile-menu-close');
            const body = document.body;
            if(!btn || !panel || !overlay) return;
            let open = false;
            let lastFocused = null;
            const focusables = () => panel.querySelectorAll('a,button,[tabindex]:not([tabindex="-1"])');
            function setOpen(v){
                open = !!v;
                panel.classList.toggle('open', open);
                overlay.classList.toggle('show', open);
                btn.setAttribute('aria-expanded', String(open));
                body.classList.toggle('no-scroll', open);
                if(open){
                    lastFocused = document.activeElement;
                    setTimeout(()=>{ (focusables()[0]||panel).focus(); }, 0);
                }else{
                    overlay.blur();
                    if(lastFocused && lastFocused.focus) lastFocused.focus();
                }
            }
            function onKey(e){
                if(!open) return;
                if(e.key === 'Escape'){ setOpen(false); }
                if(e.key === 'Tab'){
                    const f = Array.from(focusables());
                    const first = f[0], last = f[f.length-1];
                    if(!first || !last) return;
                    if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
                    else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
                }
            }
            btn.addEventListener('click', ()=> setOpen(!open));
            closeBtn?.addEventListener('click', ()=> setOpen(false));
            overlay.addEventListener('click', ()=> setOpen(false));
            document.addEventListener('keydown', onKey);
            // Click-through: mirror main nav interactions
            const linkMap = [
                ['m-domains-link', 'domains-link'],
                ['m-submit-link', 'submit-link'],
                ['m-about-link', 'about-link']
            ];
            for(const [mId, dId] of linkMap){
                const src = document.getElementById(mId);
                const dst = document.getElementById(dId);
                if(src && dst){ src.addEventListener('click', (e)=>{ e.preventDefault(); setOpen(false); dst.click(); }); }
            }
            // Auth container mirror (optional: simple view-only mount)
            const authSrc = document.getElementById('auth-container');
            const authDst = document.getElementById('m-auth-container');
            if(authSrc && authDst){
                const clone = authSrc.cloneNode(true);
                clone.id = 'auth-container-mobile';
                authDst.appendChild(clone);
            }
        })();

        // --- Policy banner (dismissible)
        // Show only in local/dev environments or when explicitly enabled via ?debugBanner=1
        (function setupPolicyBanner(){
            try {
                const banner = document.getElementById('policy-banner');
                const dismiss = document.getElementById('policy-banner-dismiss');
                if (!banner) return;

                const host = (location && location.hostname) ? location.hostname : '';
                const isLocalHost = host === 'localhost' || host === '127.0.0.1' || host.endsWith('.local');
                const isPrivateA = /^10\./.test(host);
                const isPrivateB = /^192\.168\./.test(host);
                const isPrivateC = /^172\.(1[6-9]|2[0-9]|3[0-1])\./.test(host);
                const isFileProto = (location && location.protocol === 'file:');
                const isDev = isLocalHost || isPrivateA || isPrivateB || isPrivateC || isFileProto;
                const params = new URLSearchParams(location.search || '');
                const debugForce = params.get('debugBanner') === '1';

                if (!(isDev || debugForce)) {
                    // Ensure hidden in production deployments
                    banner.classList.add('hidden');
                    return;
                }

                const KEY = 'hidePolicyBanner_v1';
                const hidden = (window.localStorage && localStorage.getItem(KEY) === 'true');
                if (!hidden) banner.classList.remove('hidden');
                dismiss?.addEventListener('click', () => {
                    banner.classList.add('hidden');
                    if (window.localStorage) localStorage.setItem(KEY, 'true');
                });
            } catch (e) { /* no-op */ }
        })();
        // NOTE: Replace the following with your actual Firebase project configuration
        const firebaseConfig = {
  apiKey: "AIzaSyDKpMZ_ik9LdcJxg3tKre-MAApV0BpI0Wo",
  authDomain: "ai-domain-atlas.firebaseapp.com",
  projectId: "ai-domain-atlas",
  storageBucket: "ai-domain-atlas.firebasestorage.app",
  messagingSenderId: "656158450742",
  appId: "1:656158450742:web:928b64678b22c12fe22497",
  measurementId: "G-ES11CRRDP6"
};
        
        // Import Firebase modules

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            signOut,
            getIdTokenResult
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            collection,
            getDocs,
            query,
            orderBy,
            limit,
            deleteDoc,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Initialize Firebase

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const firestore = getFirestore(app);

        // --- Firestore User Profile Sync ---
        async function getUserProfile(uid) {
            if (!uid) return null;
            const ref = doc(firestore, 'users', uid);
            const snap = await getDoc(ref);
            return snap.exists() ? snap.data() : null;
        }

        async function setUserProfile(uid, data) {
            if (!uid) return;
            const ref = doc(firestore, 'users', uid);
            await setDoc(ref, data, { merge: true });
        }

        async function updateUserProfileField(uid, field, value) {
            if (!uid) return;
            const ref = doc(firestore, 'users', uid);
            await updateDoc(ref, { [field]: value });
        }

        // Save favorites, reviews, comparisons
        async function saveFavorites(uid, favorites) {
            await updateUserProfileField(uid, 'favorites', favorites);
        }
        async function saveReviews(uid, reviews) {
            await updateUserProfileField(uid, 'reviews', reviews);
        }
        async function saveComparisons(uid, comparisons) {
            await updateUserProfileField(uid, 'comparisons', comparisons);
        }

        document.addEventListener('DOMContentLoaded', () => {
            let db = [];
            let toolDomainMap = new Map(); // tool name -> domain slug
            let fuse = null;
            const contentArea = document.getElementById('content-area');
            const authContainer = document.getElementById('auth-container');
            // Popularity map loaded at init (optional)
            let popularityMap = {};
            // Optional ranks file (generated by updater)
            let popularityRanksMap = {};
            // Most Popular order scores cached at init
            let mostPopularOrderMap = {};
            // Add a favorites link container after auth state is rendered
            function ensureFavoritesLinkContainer() {
                let favLink = document.getElementById('favorites-link-container');
                if (!favLink) {
                    favLink = document.createElement('span');
                    favLink.id = 'favorites-link-container';
                    favLink.className = 'ml-2';
                    if (authContainer && authContainer.lastElementChild) {
                        authContainer.appendChild(favLink);
                    }
                }
                return favLink;
            }
            // Add an admin panel link container (rendered only for admins)
            function ensureAdminLinkContainer() {
                let adminLink = document.getElementById('admin-link-container');
                if (!adminLink) {
                    adminLink = document.createElement('span');
                    adminLink.id = 'admin-link-container';
                    adminLink.className = 'ml-2';
                    if (authContainer && authContainer.lastElementChild) {
                        authContainer.appendChild(adminLink);
                    }
                }
                return adminLink;
            }
            const authModal = document.getElementById('auth-modal');
            const authForm = document.getElementById('auth-form');
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            const modalTitle = document.getElementById('modal-title');
            const authSubmitBtn = document.getElementById('auth-submit-btn');
            const modalPromptText = document.getElementById('modal-prompt-text');
            const modalSwitchBtn = document.getElementById('modal-switch-btn');
            const modalError = document.getElementById('modal-error');
            const toolDetailsModal = document.getElementById('tool-details-modal');
            const toolDetailsModalContent = document.getElementById('tool-details-modal-content');

            let isLoginMode = true;

            const state = {
                currentView: 'home',
                selectedDomain: null,
                searchQuery: '',
                selectedCategory: 'all',
                categoryExplicit: false, // whether user explicitly chose a category
                user: null,
                favorites: [],
                reviews: {},
                comparisons: [],
                isAdmin: false
            };

            // --- Ensure Firestore user document is created after login and favorites are loaded ---
            onAuthStateChanged(auth, async (user) => {
                state.user = user;
                if (user) {
                    // Load custom claims to determine admin rights
                    try {
                        const token = await getIdTokenResult(user, true);
                        state.isAdmin = !!(token?.claims?.admin);
                    } catch (e) {
                        state.isAdmin = false;
                    }
                    // Create or update user document in Firestore
                    // Create/update user profile; do NOT set/overwrite role here
                    await setDoc(doc(firestore, 'users', user.uid), {
                        profile: {
                            displayName: user.displayName || '',
                            email: user.email || '',
                            avatar: user.photoURL || ''
                        }
                    }, { merge: true });
                    // Load favorites, reviews, comparisons from Firestore
                    await loadUserProfileToState(user);
                } else {
                    // Clear user-specific state on logout
                    state.favorites = [];
                    state.reviews = {};
                    state.comparisons = [];
                    state.isAdmin = false;
                }
                // Re-render UI to reflect updated state
                render();
            });
            // --- Firestore Profile Sync Logic ---
            async function loadUserProfileToState(user) {
                if (!user || !user.uid) return;
                const profile = await getUserProfile(user.uid);
                state.favorites = Array.isArray(profile?.favorites) ? profile.favorites : [];
                state.reviews = profile?.reviews || {};
                state.comparisons = Array.isArray(profile?.comparisons) ? profile.comparisons : [];
            }

            async function saveFavoritesToFirestore() {
                if (state.user && state.user.uid) await saveFavorites(state.user.uid, state.favorites);
            }
            async function saveReviewsToFirestore() {
                if (state.user && state.user.uid) await saveReviews(state.user.uid, state.reviews);
            }
            async function saveComparisonsToFirestore() {
                if (state.user && state.user.uid) await saveComparisons(state.user.uid, state.comparisons);
            }

            // Ensure theme toggle is initialized after DOM is ready
            if (typeof setupTheme === 'function') setupTheme();

            // --- Fuse setup for search ---
            function setupFuse() {
                try {
                    const all = (db || []).flatMap(d => d.tools || []);
                    // attempt to find Fuse (UMD global or window export)
                    const FuseLib = (typeof Fuse !== 'undefined') ? Fuse : (window && window.Fuse) ? window.Fuse : null;
                    if (!FuseLib) {
                        console.warn('Fuse.js not found; search will use simple substring matching.');
                        fuse = null;
                        return;
                    }
                    // create fuse index with fields; includeScore for safer result mapping
                    fuse = new FuseLib(all, { keys: ['name', 'description', 'tags'], threshold: 0.4, includeScore: true });
                    console.debug('Fuse search index initialized with', all.length, 'tools');
                } catch (e) {
                    console.warn('setupFuse failed', e);
                    fuse = null;
                }
            }

            // --- Search & UI helper functions (new) ---
            function escapeHtml(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

            function getHostnameFromLink(link) {
                try { return new URL(link).hostname; } catch { return ''; }
            }
            function getLightPlaceholder(name, size=40) {
                const ch = encodeURIComponent((name||'?').charAt(0));
                return `https://placehold.co/${size}x${size}/f3f4f6/7c3aed?text=${ch}`;
            }
            function buildIconSources(tool, size=40) {
                const linkHost = getHostnameFromLink(tool?.link || '');
                const icon = tool?.iconUrl || '';
                const iconHost = getHostnameFromLink(icon);
                const baseHost = linkHost || iconHost || '';
                // Request multiple sizes so the browser can pick the sharpest for DPR
                const s2base = baseHost ? `https://www.google.com/s2/favicons?domain=${baseHost}` : '';
                const s2 = s2base ? `${s2base}&sz=${Math.max(64, size*2)}` : '';
                const s2_64 = s2base ? `${s2base}&sz=64` : '';
                const s2_128 = s2base ? `${s2base}&sz=128` : '';
                const s2_256 = s2base ? `${s2base}&sz=256` : '';
                const duck = baseHost ? `https://icons.duckduckgo.com/ip3/${baseHost}.ico` : '';
                const placeholder = getLightPlaceholder(tool?.name, size);

                // Prefer reliable favicon services by default; use iconUrl first only if it's same-origin
                // with the tool link or from a trusted CDN.
                const TRUSTED_ICON_HOSTS = new Set([
                    'avatars.githubusercontent.com',
                    'raw.githubusercontent.com',
                    'upload.wikimedia.org'
                ]);
                const sameOrigin = !!(icon && iconHost && linkHost && iconHost === linkHost);
                const trustedIcon = !!(icon && (sameOrigin || TRUSTED_ICON_HOSTS.has(iconHost)));

                let primary, secondary, srcset = '';
                if (trustedIcon) {
                    primary = icon;
                    secondary = s2 || duck || placeholder;
                    srcset = s2base ? `${s2_64} 1x, ${s2_128} 2x, ${s2_256} 3x` : '';
                } else {
                    primary = s2 || duck || icon || placeholder;
                    secondary = (primary === icon ? (s2 || duck) : (icon || duck)) || placeholder;
                    srcset = s2base ? `${s2_64} 1x, ${s2_128} 2x, ${s2_256} 3x` : '';
                }
                return { primary, secondary, placeholder, srcset };
            }
            function iconImgHtml(tool, size=40, extraClass='') {
                const { primary, secondary, placeholder, srcset } = buildIconSources(tool, size);
                const onerr = `this.onerror=function(){this.onerror=null; this.src='${placeholder}';}; this.src='${secondary}';`;
                const srcsetAttr = srcset ? ` srcset="${srcset}" sizes="${size}px"` : '';
                return `<img src="${primary}"${srcsetAttr} alt="${escapeHtml(tool?.name)} Logo" style="width:${size}px;height:${size}px;object-fit:contain;image-rendering:auto" class="rounded-md bg-white/80 ${extraClass}" onerror="${onerr}" loading="lazy" decoding="async">`;
            }
            function formatCountShort(n) {
                if (typeof n !== 'number' || !isFinite(n) || n <= 0) return '';
                const abs = Math.abs(n);
                if (abs >= 1e9) return `${(n/1e9).toFixed(abs >= 1e10 ? 0 : 1)}B`;
                if (abs >= 1e6) return `${(n/1e6).toFixed(abs >= 1e7 ? 0 : 1)}M`;
                if (abs >= 1e3) return `${(n/1e3).toFixed(abs >= 1e4 ? 0 : 1)}K`;
                return n.toLocaleString();
            }
            function getUsersCount(tool) {
                const direct = tool?.users ?? tool?.monthlyUsers ?? tool?.popularity ?? tool?.userCount;
                let n = Number(direct);
                if (!Number.isFinite(n) || n <= 0) {
                    const key = String(tool?.name || '').trim().toLowerCase();
                    n = Number(popularityMap[key]);
                }
                return Number.isFinite(n) && n > 0 ? n : null;
            }

            // --- Search result hygiene: exclusions + de-duplication by name ---
            const EXCLUDED_TOOLS_BY_NAME = new Set([
                'gemini for workspace'
            ]);
            function normName(s){ return String(s||'').trim().toLowerCase(); }
            function isExcludedTool(tool){ return EXCLUDED_TOOLS_BY_NAME.has(normName(tool?.name)); }
            // choose the better variant when the same tool appears in multiple domains
            function pickBetterVariant(a, b){
                const ua = getUsersCount(a) || 0;
                const ub = getUsersCount(b) || 0;
                if (ua !== ub) return ua > ub ? a : b;
                const la = (a?.description||'').length;
                const lb = (b?.description||'').length;
                if (la !== lb) return la > lb ? a : b;
                const ia = a?.iconUrl ? 1 : 0;
                const ib = b?.iconUrl ? 1 : 0;
                if (ia !== ib) return ia > ib ? a : b;
                // fallback: keep first (a)
                return a;
            }
            function dedupeAndFilterTools(list){
                const out = new Map();
                for (const t of (list||[])){
                    if (!t || !t.name) continue;
                    if (isExcludedTool(t)) continue;
                    const k = normName(t.name);
                    const cur = out.get(k);
                    if (!cur) out.set(k, t);
                    else out.set(k, pickBetterVariant(cur, t));
                }
                return Array.from(out.values());
            }
            function usersBadgeHtml(tool) {
                const n = getUsersCount(tool);
                if (n) {
                    const txt = `${formatCountShort(n)} users`;
                    return `<span class="ml-2 text-xs px-2 py-0.5 rounded-full border border-purple-200 bg-purple-50 text-purple-700 whitespace-nowrap dark:bg-purple-900/30 dark:border-purple-700 dark:text-purple-200">${txt}</span>`;
                }
                // Fallback: show popularity rank if available, else N/A
                const key = (tool?.name || '').toLowerCase();
                // Prefer rank from generated ranks map if available
                const directRank = Number(popularityRanksMap[key] || 0);
                if (directRank > 0) {
                    return `<span class="ml-2 text-xs px-2 py-0.5 rounded-full border border-amber-200 bg-amber-50 text-amber-700 whitespace-nowrap dark:bg-amber-900/30 dark:border-amber-700 dark:text-amber-200">#${directRank}</span>`;
                }
                // Else compute from Most Popular section order
                const rankScore = Number(mostPopularOrderMap[key] || 0);
                if (rankScore > 0) {
                    const values = Object.values(mostPopularOrderMap).sort((a,b)=>b-a);
                    const rank = values.indexOf(rankScore) + 1;
                    if (rank > 0) return `<span class="ml-2 text-xs px-2 py-0.5 rounded-full border border-amber-200 bg-amber-50 text-amber-700 whitespace-nowrap dark:bg-amber-900/30 dark:border-amber-700 dark:text-amber-200">#${rank}</span>`;
                }
                return `<span class="ml-2 text-xs px-2 py-0.5 rounded-full border border-gray-200 bg-gray-50 text-gray-600 whitespace-nowrap dark:bg-gray-800/40 dark:border-gray-700 dark:text-gray-300">N/A</span>`;
            }

            function performSearch(q) {
                const query = (q || '').trim();
                if (!query) return [];
                try {
                    if (fuse) {
                        try {
                            const results = fuse.search(query, { limit: 50 });
                            // Fuse v6 returns array of { item, score } objects; some configs may return item directly
                            const mapped = Array.isArray(results) ? results.map(r => (r && r.item) ? r.item : r) : [];
                            const cleaned = dedupeAndFilterTools(mapped);
                            console.debug('performSearch (fuse) query=', query, 'matches=', mapped.length, 'after dedupe/exclude=', cleaned.length);
                            return cleaned;
                        } catch (fe) {
                            console.warn('Fuse search threw, falling back to substring match', fe);
                        }
                    }
                    // Fallback substring search across name, description, tags
                    const allTools = (db || []).flatMap(d => d.tools || []);
                    const ql = query.toLowerCase();
                    const filtered = allTools.filter(t => {
                        const name = (t.name || '').toLowerCase();
                        const desc = (t.description || '').toLowerCase();
                        const tags = Array.isArray(t.tags) ? t.tags.join(' ').toLowerCase() : (String(t.tags || '')).toLowerCase();
                        return name.includes(ql) || desc.includes(ql) || tags.includes(ql);
                    }).slice(0, 50);
                    const cleaned = dedupeAndFilterTools(filtered);
                    console.debug('performSearch (fallback) query=', query, 'matches=', filtered.length, 'after dedupe/exclude=', cleaned.length);
                    return cleaned;
                } catch (e) {
                    console.error('performSearch error', e);
                    return [];
                }
            }

            function renderSearchTile(tool) {
                const iconHtml = iconImgHtml(tool, 52, 'mb-2 cursor-pointer open-tool-logo');
                const pricing = (() => {
                    const tags = (tool.tags||[]).map(t=>String(t).toLowerCase());
                    const priceField = String(tool.price||'').toLowerCase();
                    if (tags.some(t=>/open[\s-]?source|^oss$/.test(t))) return 'Open Source';
                    if (tags.some(t=>/freemium/.test(t))) return 'Freemium';
                    if (tags.some(t=>/(paid|subscription|subscribe|premium|enterprise)/.test(t)) || /(paid|subscription|premium|enterprise)/.test(priceField)) return 'Paid/Subscription';
                    if (tags.some(t=>/free/.test(t)) || priceField === 'free') return 'Free';
                    return '';
                })();
                const pricingClass = (() => {
                    switch (pricing) {
                        case 'Free': return 'text-teal-600 dark:text-teal-300';
                        case 'Freemium': return 'text-indigo-600 dark:text-indigo-300';
                        case 'Paid/Subscription': return 'text-orange-600 dark:text-orange-300';
                        case 'Open Source': return 'text-green-600 dark:text-green-300';
                        default: return 'text-purple-700 dark:text-purple-300';
                    }
                })();
                const blurb = (() => {
                    const q = String(state.searchQuery||'').toLowerCase();
                    const tags = (tool.tags||[]).map(t=>String(t).toLowerCase());
                    const name = String(tool.name||'');
                    const has = (w) => q.includes(w) || tags.some(t=>t.includes(w));
                    if (has('video')) {
                        if (has('edit') || has('editor') || has('cut')) return 'Great for video editing';
                        if (has('text-to-video') || has('t2v') || has('generate')) return 'Good for new video generation';
                        if (has('transcription') || has('subtitle') || has('caption')) return 'Helpful for captions/subtitles';
                        if (has('effects') || has('fx') || has('filter')) return 'Video effects and styling';
                        if (has('translation')) return 'Video translation/localization';
                        return 'Video tooling';
                    }
                    if (has('image') || has('img') || has('photo')) {
                        if (has('edit') || has('inpaint') || has('retouch')) return 'Great for image editing';
                        if (has('generate') || has('gen') || has('text-to-image')) return 'Good for new image generation';
                        if (has('upscale') || has('enhance')) return 'Image upscaling/enhancement';
                        return 'Image tooling';
                    }
                    if (has('audio') || has('music') || has('speech')) {
                        if (has('tts') || has('voice') || has('synthesis')) return 'Text-to-speech/voice';
                        if (has('stt') || has('transcribe')) return 'Speech-to-text/transcription';
                        return 'Audio tooling';
                    }
                    if (has('code') || has('developer')) return 'Developer tools';
                    if (has('agent')) return 'Agents & orchestration';
                    if (has('search') || has('knowledge')) return 'Search & discovery';
                    return '';
                })();
                return `
                    <div class="tile-card card-hover-effect relative" role="listitem" data-name="${escapeHtml(tool.name)}">
                        ${pricing ? `<div class=\"absolute top-2 right-2 text-[0.72rem] font-semibold ${pricingClass}\">${escapeHtml(pricing)}</div>` : ''}
                        <div class="flex flex-col items-center">
                            <div class="rounded-full p-1 bg-white/80 shadow-sm" role="button" aria-label="Open ${escapeHtml(tool.name)}" data-name="${escapeHtml(tool.name)}">${iconHtml}</div>
                            <div class="tile-title mt-1">${escapeHtml(tool.name)} ${usersBadgeHtml(tool)}</div>
                            ${blurb ? `<div class="tile-blurb mt-1">${escapeHtml(blurb)}</div>` : ''}
                        </div>
                    </div>
                `;
            }

            // expose an opener used by result buttons
            function openToolByName(toolName) {
                const domain = (db || []).find(d => (d.tools || []).some(t => t.name === toolName));
                if (!domain) return;
                state.selectedDomain = domain.slug;
                state.currentView = 'tools';
                try { location.hash = `#domain=${encodeURIComponent(state.selectedDomain)}&tool=${encodeURIComponent(toolName)}`; } catch (e) {}
                render();
                setTimeout(() => {
                    const tool = domain.tools.find(t => t.name === toolName);
                    if (tool) {
                        openToolDetailsModal(tool);
                    }
                }, 250);
            }
            window.openToolByName = openToolByName;

            // --- UI RENDERING ---

            const renderHome = () => { /* placeholder if needed */ };
            const renderTools = () => { /* placeholder if needed */ };
            const renderToolCard = (tool) => { /* placeholder if needed */ };
            const renderAbout = () => { /* placeholder if needed */ };
            const renderSubmit = () => { /* placeholder if needed */ };

            // --- Admin Panel ---
            function domainNameToSlug(name){
                const d = (db || []).find(x => String(x.name).toLowerCase() === String(name||'').toLowerCase());
                return d?.slug || String(name||'').toLowerCase().replace(/\s+/g,'-');
            }
            function defaultTagsForDomain(slug){
                const m = {
                    'language-chat': ['LLM'],
                    'code-assistance': ['Code'],
                    'image-generation': ['Images'],
                    'video-tools': ['Video'],
                    'audio-music': ['Audio'],
                    'productivity': ['Productivity'],
                    'data-analysis': ['Data'],
                    'search-knowledge-discovery': ['Search'],
                    'workflow-automation': ['Automation'],
                    'prompt-enhancers': ['Prompts'],
                    'design-tools': ['Design'],
                    'education': ['Education'],
                    'marketing-seo': ['Marketing'],
                    '3d-modeling': ['3D'],
                    'crypto': ['Crypto'],
                    'ai-safety-ethics': ['Safety']
                };
                return m[slug] || [];
            }
            async function fetchSubmissionsList() {
                try {
                    // Prefer ordering by createdAt if available
                    const col = collection(firestore, 'submissions');
                    let snap;
                    try {
                        const qy = query(col, orderBy('createdAt', 'desc'), limit(50));
                        snap = await getDocs(qy);
                    } catch (e) {
                        // Fallback if no index/field
                        snap = await getDocs(col);
                    }
                    const items = [];
                    snap.forEach(docu => items.push({ id: docu.id, ...(docu.data()||{}) }));
                    // Pending first
                    return items.sort((a,b)=>String(a.status||'pending').localeCompare(String(b.status||'pending')));
                } catch (e) {
                    console.warn('Failed to load submissions:', e);
                    return [];
                }
            }

            // Domain ordering helper: place 'github-ai-projects' at the 8th position (index 7) on home and dropdowns
            function getOrderedDomains() {
                try {
                    const list = Array.isArray(db) ? db.slice() : [];
                    const idx = list.findIndex(d => String(d?.slug || '') === 'github-ai-projects');
                    if (idx !== -1) {
                        const section = list.splice(idx, 1)[0];
                        const insertAt = Math.min(7, list.length); // 0-based -> 7 means 8th position
                        list.splice(insertAt, 0, section);
                    }
                    return list;
                } catch { return Array.isArray(db) ? db : []; }
            }

            async function approveSubmission(id) {
                try {
                    await updateDoc(doc(firestore, 'submissions', id), { status: 'approved', approvedAt: serverTimestamp() });
                    return true;
                } catch (e) { console.error('approveSubmission failed', e); return false; }
            }
            async function deleteSubmissionById(id) {
                try { await deleteDoc(doc(firestore, 'submissions', id)); return true; }
                catch (e) { console.error('deleteSubmission failed', e); return false; }
            }

            async function renderAdmin() {
                if (!state.user || !state.isAdmin) {
                    contentArea.innerHTML = `<div class="max-w-2xl mx-auto text-center p-8 bg-card border border-color rounded-xl">Admin access required.</div>`;
                    return;
                }
                contentArea.innerHTML = `
                    <div class="max-w-5xl mx-auto mb-16">
                        <div class="flex items-start justify-between gap-4 mb-6">
                            <div>
                                <h1 class="text-3xl md:text-4xl font-bold text-primary">Admin Panel</h1>
                                <p class="text-secondary">Signed in as <strong>${escapeHtml(state.user.email||state.user.uid)}</strong></p>
                            </div>
                            <div class="flex gap-2">
                                <button id="admin-refresh" class="px-3 py-2 rounded border text-sm bg-secondary text-primary">Refresh</button>
                                <a href="#" id="admin-back-home" class="px-3 py-2 rounded border text-sm bg-white text-purple-700 border-purple-300 hover:bg-purple-50">Back</a>
                            </div>
                        </div>
                        <div class="bg-card border border-color rounded-xl p-4">
                            <h2 class="text-xl font-semibold mb-3">Submissions (Pending)</h2>
                            <div id="admin-submissions" class="text-secondary">Loading submissions...</div>
                            <p class="text-xs text-muted mt-2">Actions are enforced by Firestore rules. Approve & Add creates the tool in its domain and records approval. Reject marks the submission as rejected.</p>
                            <h2 class="text-xl font-semibold mt-10 mb-3">History (Approved)</h2>
                            <div id="admin-history" class="text-secondary">Loading...</div>
                        </div>
                    </div>`;

                async function loadSubs() {
                                        const container = document.getElementById('admin-submissions');
                                        const historyEl = document.getElementById('admin-history');
                                        const subs = await fetchSubmissionsList();
                                        // Try to fetch scored hints (optional)
                                        let scoredMap = new Map();
                                        try {
                                            const r = await fetch('/pending-tools.scored.json', { cache: 'no-store' });
                                            if (r.ok) {
                                                const arr = await r.json();
                                                (arr||[]).forEach(x => {
                                                    const k = String(x.name||'').toLowerCase();
                                                    if(k) scoredMap.set(k, x);
                                                    const lk = (()=>{ try{return new URL(x.link||'').hostname.toLowerCase();}catch{return '';} })();
                                                    if(lk && !scoredMap.has(lk)) scoredMap.set(lk, x);
                                                });
                                            }
                                        } catch {}
                                        const pending = subs.filter(s => String(s.status||'pending') === 'pending');
                                        const approved = subs.filter(s => String(s.status||'') === 'approved');
                                        container.innerHTML = pending.length ? `
                        <div class="overflow-x-auto">
                          <table class="min-w-full text-sm">
                            <thead>
                              <tr class="text-left text-secondary">
                                <th class="py-2 pr-4">Title</th>
                                <th class="py-2 pr-4">Status</th>
                                <th class="py-2 pr-4">Submitted By</th>
                                                                <th class="py-2 pr-4">Actions</th>
                              </tr>
                            </thead>
                            <tbody>
                                                                                                                        ${pending.map(s => `
                                <tr class="border-t border-color">
                                  <td class="py-2 pr-4">${escapeHtml(s.title || s.name || s.link || s.id)}</td>
                                                                    <td class="py-2 pr-4">${escapeHtml(s.status || 'pending')}</td>
                                                                    <td class="py-2 pr-4">${escapeHtml(s.createdBy || s.submitterEmail || s.email || '')}</td>
                                                                    <td class="py-2 pr-4">
                                                                        ${(() => {
                                                                                const key = String(s.title||s.name||'').toLowerCase();
                                                                                let hint = scoredMap.get(key);
                                                                                if(!hint && s.link){
                                                                                    try { const host = new URL(s.link).hostname.toLowerCase(); hint = scoredMap.get(host) || hint; } catch {}
                                                                                }
                                                                                if (!hint) return '<div class="text-xs text-muted">No ML hint</div>';
                                                                                const dec = String(hint.mlDecision||'').toLowerCase();
                                                                                const score = typeof hint.mlScore === 'number' ? hint.mlScore.toFixed(2) : '—';
                                                                                const badgeCls = dec === 'approve' ? 'bg-emerald-100 text-emerald-800' : 'bg-rose-100 text-rose-800';
                                                                                const sims = Array.isArray(hint.mlSimilar) ? hint.mlSimilar.slice(0,3) : [];
                                                                                const similarHtml = sims.length ? `<div class="mt-1 text-xs text-secondary">Similar: ${sims.map(x=>`${escapeHtml(x.name)}${x.domainSlug?` (${escapeHtml(x.domainSlug)})`:''}`).join(', ')}</div>` : '';
                                                                                return `<div class="inline-flex items-center gap-2 text-xs"><span class="px-2 py-0.5 rounded ${badgeCls}">Model: ${dec==='approve'?'Approve':'Reject'} (${score})</span></div>${similarHtml}`;
                                                                        })()}
                                                                        <div class="mt-2 flex gap-2">
                                                                        <button class="admin-approve-add px-2 py-1 rounded border text-xs bg-green-100 text-green-800" data-id="${escapeHtml(s.id)}" data-title="${escapeHtml(s.title || '')}" data-link="${escapeHtml(s.link || '')}" data-domain="${escapeHtml(s.domain || '')}" data-description="${escapeHtml(s.description || '')}" data-email="${escapeHtml(s.submitterEmail || s.createdBy || '')}">Approve & Add</button>
                                                                        <button class="admin-reject px-2 py-1 rounded border text-xs bg-red-100 text-red-700" data-id="${escapeHtml(s.id)}">Reject</button>
                                                                        </div>
                                  </td>
                                </tr>`).join('')}
                            </tbody>
                          </table>
                                                </div>` : '<div class="text-muted">No pending submissions.</div>';

                                        historyEl.innerHTML = approved.length ? `
                                                <div class="overflow-x-auto">
                            // Serverless notifications disabled (no Netlify)
                                                                <th class="py-2 pr-4">Title</th>
                                                                <th class="py-2 pr-4">Approved</th>
                                                                <th class="py-2 pr-4">Approved By</th>
                                                                <th class="py-2 pr-4">Link</th>
                                                                <th class="py-2 pr-4">Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            ${approved.map(s => `
                                                                <tr class="border-t border-color">
                                                                    <td class="py-2 pr-4">${escapeHtml(s.title || s.name || s.link || s.id)}</td>
                                                                    <td class="py-2 pr-4">${s.approvedAt && s.approvedAt.seconds ? new Date(s.approvedAt.seconds * 1000).toLocaleString() : ''}</td>
                                                                    <td class="py-2 pr-4">${escapeHtml(s.approvedBy || '')}</td>
                                                                    <td class="py-2 pr-4">${s.link ? `<a href="${escapeHtml(s.link)}" class="text-blue-600 hover:underline" target="_blank" rel="noopener">Visit</a>` : ''}</td>
                                                              <td class="py-2 pr-4">
                                                                ${s.approvedToolId ? `<button class="admin-delete-tool px-2 py-1 rounded border text-xs bg-red-50 text-red-700" data-tool-id="${escapeHtml(s.approvedToolId)}" data-sub-id="${escapeHtml(s.id)}">Delete Tool</button>` : `<span class="text-xs text-muted">No linked tool</span>`}
                                                              </td>
                                                                </tr>`).join('')}
                                                        </tbody>
                                                    </table>
                                                </div>` : '<div class="text-muted">No approved items yet.</div>';

                    // Wire actions
                    document.querySelectorAll('.admin-reject').forEach(btn => btn.addEventListener('click', async (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        if (!id) return;
                        try {
                            await updateDoc(doc(firestore, 'submissions', id), {
                                status: 'rejected',
                                rejectedAt: serverTimestamp(),
                                rejectedBy: state.user?.email || state.user?.uid || 'admin'
                            });
                            loadSubs();
                        } catch (err) {
                            console.error(err);
                            alert('Failed to reject submission');
                        }
                    }));
                    document.querySelectorAll('.admin-approve-add').forEach(btn => btn.addEventListener('click', async (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        const title = e.currentTarget.getAttribute('data-title') || '';
                        const link = e.currentTarget.getAttribute('data-link') || '';
                        const domain = e.currentTarget.getAttribute('data-domain') || '';
                        const description = e.currentTarget.getAttribute('data-description') || '';
                        const submitterEmail = e.currentTarget.getAttribute('data-email') || '';
                        if (!title || !link) { alert('Missing name or link'); return; }
                        try {
                            const domainSlug = domainNameToSlug(domain);

                            // Enrichment: skip serverless calls (Netlify removed). Default to local fields only.
                            let enriched = { name: '', description: '', iconUrl: '' };

                            const toolDoc = {
                                name: (enriched.name || title).trim(),
                                link,
                                description: (enriched.description || '').trim(),
                                iconUrl: (enriched.iconUrl || '').trim(),
                                domainSlug,
                                tags: defaultTagsForDomain(domainSlug),
                                status: 'active',
                                createdAt: new Date(),
                                createdBy: state.user?.email || state.user?.uid || 'admin'
                            };
                            const newRef = doc(collection(firestore, 'tools'));
                            await setDoc(newRef, toolDoc);
                            // Mark submission approved with history details
                            try {
                                await updateDoc(doc(firestore, 'submissions', id), {
                                    status: 'approved',
                                    approvedAt: serverTimestamp(),
                                    approvedBy: state.user?.email || state.user?.uid || 'admin',
                                    approvedToolId: newRef.id,
                                    approvedToolDomain: domainSlug
                                });
                            } catch {}

                            // Notification emails skipped (no serverless backend configured)

                            alert('Approved and added. The exporter will append to public/tools.json via PR.');
                            loadSubs();
                        } catch (err) {
                            console.error(err);
                            alert('Failed to add tool');
                        }
                    }));
                    document.querySelectorAll('.admin-delete-tool').forEach(btn => btn.addEventListener('click', async (e) => {
                        const toolId = e.currentTarget.getAttribute('data-tool-id');
                        const subId = e.currentTarget.getAttribute('data-sub-id');
                        if (!toolId) { alert('No linked tool id'); return; }
                        if (!confirm('Delete this tool from the catalog (Firestore)? This will require a manual removal in tools.json or running the exporter with shrink allowance.')) return;
                        try {
                            await deleteDoc(doc(firestore, 'tools', toolId));
                            try {
                                await updateDoc(doc(firestore, 'submissions', subId), {
                                    toolDeletedAt: serverTimestamp(),
                                    approvedToolId: null
                                });
                            } catch {}
                            alert('Tool deleted from Firestore. Note: tools.json removal requires an explicit action (PR or exporter with --allow-shrink).');
                            loadSubs();
                        } catch (err) {
                            console.error(err);
                            alert('Failed to delete tool');
                        }
                    }));
                }

                document.getElementById('admin-refresh').addEventListener('click', (e) => { e.preventDefault(); loadSubs(); });
                document.getElementById('admin-back-home').addEventListener('click', (e) => { e.preventDefault(); state.currentView = 'home'; render(); });
                loadSubs();
            }

            // --- Render Favorites Page ---
            function renderFavorites() {
                // Categorize favorites by domain
                const allDomains = db || [];
                const favSet = new Set(state.favorites || []);
                // Map: domainSlug -> { domain, tools: [tool, ...] }
                const domainFavs = allDomains.map(domain => {
                    const tools = (domain.tools || []).filter(t => favSet.has(t.name));
                    return tools.length ? { domain, tools } : null;
                }).filter(Boolean);
                contentArea.innerHTML = `
                    <div class="max-w-4xl mx-auto mt-10 mb-16">
                        <div class="relative mb-6 pt-10">
                            <!-- Back to Domains - top-left corner -->
                            <a href="#" id="back-to-domains-link" class="absolute left-0 top-0 text-purple-600 hover:underline flex items-center text-base md:text-lg font-medium">
                                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                                Back to Domains
                            </a>
                            <!-- Reset Favorites - top-right corner -->
                            <button id="reset-favorites-btn" class="absolute right-0 top-0 px-4 py-2 rounded bg-red-100 text-red-700 font-semibold hover:bg-red-200 transition text-sm">Reset Favorites</button>
                            <!-- Centered title -->
                            <h1 class="text-3xl md:text-4xl font-bold text-purple-700 text-center flex items-center justify-center gap-2">
                                <svg class="w-7 h-7 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l2.036 6.29a1 1 0 00.95.69h6.631c.969 0 1.371 1.24.588 1.81l-5.37 3.905a1 1 0 00-.364 1.118l2.036 6.29c.3.921-.755 1.688-1.538 1.118l-5.37-3.905a1 1 0 00-1.175 0l-5.37 3.905c-.783.57-1.838-.197-1.538-1.118l2.036-6.29a1 1 0 00-.364-1.118L2.342 11.717c-.783-.57-.38-1.81.588-1.81h6.631a1 1 0 00.95-.69l2.036-6.29z"/></svg>
                                My Favorite AI Apps
                            </h1>
                        </div>
                        ${domainFavs.length === 0 ? `<div class="text-secondary text-lg">You have not added any favorites yet.</div>` : `
                            <div class="flex flex-col gap-8">
                                ${domainFavs.map(df => `
                                    <div>
                                        <h2 class="text-2xl font-bold text-primary mb-3 flex items-center gap-2">
                                            <span class="text-purple-500">${df.domain.icon || ''}</span>
                                            ${escapeHtml(df.domain.name)}
                                        </h2>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                            ${df.tools.map(tool => `
                                                <div class="bg-card border border-color rounded-xl p-4 flex items-center gap-4 card-hover-effect">
                                                    ${iconImgHtml(tool, 48, 'flex-shrink-0')}
                                                    <div class="flex-1 min-w-0">
                                                        <div class="font-semibold text-lg text-primary truncate">${escapeHtml(tool.name)} ${usersBadgeHtml(tool)}</div>
                                                        <div class="text-sm text-secondary truncate">${escapeHtml(tool.description || '')}</div>
                                                    </div>
                                                    <button class="open-tool-btn px-3 py-1 rounded border text-sm bg-purple-600 text-white" data-name="${escapeHtml(tool.name)}">Open</button>
                                                    <a href="${tool.link || '#'}" target="_blank" class="ml-1 px-3 py-1 rounded border text-sm bg-white text-purple-700 border-purple-300 hover:bg-purple-50">Visit</a>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                `;
                // Attach open button listeners
                document.querySelectorAll('.open-tool-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const name = e.currentTarget.getAttribute('data-name');
                        openToolByName(name);
                    });
                });
                // Attach reset button listener
                // Attach back to domains link listener
                const backLink = document.getElementById('back-to-domains-link');
                if (backLink) {
                    backLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        state.currentView = 'home';
                        render();
                    });
                }
                const resetBtn = document.getElementById('reset-favorites-btn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        if (confirm('Are you sure you want to remove all your favorites?')) {
                            state.favorites = [];
                            saveFavoritesToFirestore().then(() => renderFavorites());
                        }
                    });
                }
            }

            // --- Re-implementing core render functions to avoid code duplication ---
            const originalRenderFunctions = {
                renderHome: () => {
                    // Reset category selector to placeholder when entering home
                    state.selectedCategory = 'all';
                    state.categoryExplicit = false;
                    // Show domains and redesigned search UI
                    // No favorites overlay on homepage
                    contentArea.innerHTML = `
                        <div class="relative">
                            <!-- Hero: centered title + search -->
                            <section class="min-h-[46vh] md:min-h-[52vh] flex flex-col justify-center items-center text-center">
                                <!-- Tool Count Banner -->
                                <div class="mb-1 md:mb-2">
                                    <div class="inline-flex items-center gap-2">
                                        <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                                        </svg>
                                        <span class="text-lg md:text-xl font-semibold text-primary">
                                            ${(() => { const total = db.reduce((sum, section) => sum + (section.tools?.length || 0), 0); const rounded = Math.round(total / 100) * 100; return rounded; })()}+ AI Tools Curated
                                        </span>
                                    </div>
                                </div>
                                <div class="mb-2.5 md:mb-4">
                                    <h1 class="text-[2.25rem] md:text-[3.5rem] font-bold tracking-tight text-primary mb-2">Welcome to <span class="text-primary">AI ToolVerse</span></h1>
                                    <p class="max-w-2xl mx-auto text-[1.26rem] md:text-[1.38rem] text-gray-900 dark:text-gray-100">Endless AI Tools. Infinite Possibilities.</p>
                                </div>
                                <!-- Unified Search + Filter dropdown -->
                                <div class="w-full max-w-4xl mx-auto">
                                    <div id="search-filter-unit" class="relative flex items-center">
                                        <div class="relative flex-1">
                                            <span class="absolute left-4 top-1/2 -translate-y-1/2 text-xl text-gray-400 dark:text-gray-500 pointer-events-none">🔍</span>
                                            <input id="search-bar-new" class="search-input w-full h-[46px] md:h-[52px] rounded-l-full border-r-0 pl-12" type="search" placeholder="Search tools by name, tag or description..." value="${escapeHtml(state.searchQuery || '')}">
                                        </div>
                                        <button id="filter-button" class="h-[46px] md:h-[52px] bg-purple-600 text-white px-4 md:px-5 rounded-r-full border border-purple-700 border-l-0 flex items-center gap-2">
                                            <span>Filter</span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.06l3.71-3.83a.75.75 0 111.08 1.04l-4.25 4.39a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                                        </button>
                                        <!-- Dropdown is absolutely positioned within the search/filter container so its top aligns below the Filter button -->
                                        <div id="filter-menu" class="hidden absolute right-0 top-full mt-2 w-80 max-h-[60vh] overflow-y-auto bg-card border border-color rounded-xl shadow-lg"></div>
                                    </div>
                                </div>
                                <div id="search-results-container" class="w-full max-w-7xl mx-auto mt-4 px-2 md:px-0"></div>
                            </section>

                            <!-- Top Tools rotating strip (shows top 20, 6 visible) -->
                            <div id="top-tools-strip" class="mb-10 md:mb-12 mt-[0.675rem] md:mt-[0.9rem]"></div>

                            <div id="domain-tiles-anchor" class="h-0"></div>
                            <h2 class="text-3xl font-bold text-primary mb-6 md:mb-8 mt-6 md:mt-4">Explore AI tools by domain</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 md:gap-7 lg:gap-8">
                                ${ getOrderedDomains().map(domain => `<div class="domain-card card-hover-effect p-6" data-slug="${domain.slug}"><div class="text-purple-500 mb-4">${domain.icon || ''}</div><h3 class="text-xl font-semibold text-primary mb-2">${domain.name}</h3><p class="text-secondary text-sm flex-grow">${domain.description || ''}</p></div>`).join('')}
                            </div>
                        </div>
                    `;

                    // wire search behavior
                    const sb = document.getElementById('search-bar-new');
                    const clearBtn = null; // clear removed
                    const resultsContainer = document.getElementById('search-results-container');
                    const topStripEl = document.getElementById('top-tools-strip');

                    // --- Top Tools rotating strip (logo + name only) ---
                    function stripIconImgHtml(tool, size=48) {
                        const { primary, secondary, placeholder } = buildIconSources(tool, size);
                        const onerr = `this.onerror=function(){this.onerror=null; this.src='${placeholder}';}; this.src='${secondary}';`;
                        // Inline border-radius + subtle ring to guarantee circular shape and match screenshot style
                        return `<img src="${primary}" alt="${escapeHtml(tool?.name)} Logo" style="width:${size}px;height:${size}px;border-radius:9999px;border:1px solid rgba(0,0,0,0.08);background:#fff;object-fit:cover" class="flex-shrink-0" onerror="${onerr}">`;
                    }
                    function scoreToolForTop(tool) {
                        try {
                            const key = String(tool?.name || '').trim().toLowerCase();
                            const users = getUsersCount(tool);
                            if (Number.isFinite(users) && users > 0) return users + 1_000_000; // prioritize direct user counts
                            const rank = Number(popularityRanksMap[key] || 0);
                            if (rank > 0) return 500_000 - rank; // lower rank -> higher score
                            const orderScore = Number(mostPopularOrderMap[key] || 0);
                            if (orderScore > 0) return orderScore;
                            return 0;
                        } catch { return 0; }
                    }

                    function computeTopTools(limit = 30) {
                        const allTools = (db || []).flatMap(d => d.tools || []).filter(t => !isExcludedTool(t));
                        // de-duplicate by name (case-insensitive)
                        const seen = new Map();
                        for (const t of allTools) {
                            const k = String(t?.name || '').trim().toLowerCase();
                            if (!k) continue;
                            const current = seen.get(k);
                            if (!current) {
                                seen.set(k, { tool: t, score: scoreToolForTop(t) });
                            } else {
                                // keep higher scoring duplicate
                                const newScore = scoreToolForTop(t);
                                if (newScore > current.score) seen.set(k, { tool: t, score: newScore });
                            }
                        }
                        return Array.from(seen.values())
                            .sort((a,b) => b.score - a.score)
                            .slice(0, limit)
                            .map(x => x.tool);
                    }

                    // Responsive visible count for carousel: 3 on mobile (<640px), 5 otherwise
                    function getTopVisible() {
                        try { return (window.innerWidth || 0) < 640 ? 3 : 5; } catch { return 5; }
                    }
                    const STEP_MS = 2000; // time per slide step
                    const TRANSITION_MS = 500; // slide animation duration
                    const GAP_REM = 0.45; // reduced by ~25% from 0.6rem (visible spacing)
                    const EDGE_FADE_PX = 48; // fade width on both ends for 3D effect
                    const topTools = computeTopTools(30);

                    // Keep globals to clean up between renders
                    if (window.topStripInterval) { try { clearInterval(window.topStripInterval); } catch {} window.topStripInterval = null; }
                    if (window.topStripResizeHandler) { try { window.removeEventListener('resize', window.topStripResizeHandler); } catch {} window.topStripResizeHandler = null; }

                    function renderTopStrip() {
                        if (!topStripEl) return;
                        if (!topTools || topTools.length === 0) { topStripEl.innerHTML = ''; return; }
                        const visible = Math.min(getTopVisible(), topTools.length);
                        const iconSize = ((window.innerWidth || 0) < 640) ? 40 : 48;
                        // duplicate first `visible` items to end for seamless looping
                        const trackTools = topTools.concat(topTools.slice(0, visible));
                        const gaps = Math.max(0, visible - 1);
                        const itemWidthCalc = `calc((100% - (${gaps} * ${GAP_REM}rem)) / ${visible})`;
                        const items = trackTools.map((t, idx) => `
                            <div class="top-item flex flex-col items-center justify-center px-1 py-2 card-hover-effect min-w-0" data-real-idx="${idx % topTools.length}" style="flex:0 0 ${itemWidthCalc};max-width:${itemWidthCalc};">
                                ${stripIconImgHtml(t, iconSize)}
                                <span class="mt-2 text-sm font-medium text-center truncate w-full" title="${escapeHtml(t?.name)}">${escapeHtml(t?.name)}</span>
                            </div>
                        `);
                        topStripEl.innerHTML = `
                            <div class="max-w-4xl mx-auto">
                                <!-- Carousel Heading -->
                                <div class="flex items-center justify-center gap-2 mb-4">
                                    <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                    <h2 class="text-xl md:text-[1.6rem] font-bold text-primary">Most Popular AI Tools</h2>
                                    <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                                <div id="top-strip-container" class="relative bg-secondary/40 border border-color rounded-2xl p-3 overflow-hidden">
                                    <div id="top-strip-viewport" class="overflow-hidden rounded-full" style="cursor:grab; touch-action: pan-y; -webkit-mask-image: linear-gradient(to right, transparent 0, black ${EDGE_FADE_PX}px, black calc(100% - ${EDGE_FADE_PX}px), transparent 100%); mask-image: linear-gradient(to right, transparent 0, black ${EDGE_FADE_PX}px, black calc(100% - ${EDGE_FADE_PX}px), transparent 100%);">
                                        <div id="top-strip-track" class="flex items-start will-change-transform" style="gap:${GAP_REM}rem; transform: translateX(0); transition: transform ${TRANSITION_MS}ms ease;">
                                            ${items.join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="sm:hidden text-center mt-1 text-secondary select-none" aria-hidden="true">• • •</div>
                            </div>
                        `;

                        const trackEl = document.getElementById('top-strip-track');
                        const containerEl = document.getElementById('top-strip-container');
                        const viewportEl = document.getElementById('top-strip-viewport');
                        if (!trackEl || !containerEl) return;

                        // Direct item handlers (click) using data-real-idx; suppress accidental navigation after drag
                        trackEl.querySelectorAll('.top-item').forEach((el) => {
                            el.addEventListener('click', (e) => {
                                if (didDrag) return;
                                e.preventDefault();
                                e.stopPropagation();
                                const ri = Number(el.getAttribute('data-real-idx'));
                                if (!Number.isFinite(ri)) return;
                                const t = topTools[ri];
                                if (t && t.name && typeof openToolByName === 'function') openToolByName(t.name);
                            });
                        });

                        let step = 0; // number of items shifted
                        let deltaX = 0; // distance per step in px
                        let isDragging = false;
                        let dragStartX = 0;
                        let dragDx = 0;
                        let stepAtDown = 0;
                        let didDrag = false;

                        function measureDelta() {
                            const items = trackEl.querySelectorAll('.top-item');
                            if (items.length >= 2) {
                                const a = items[0].getBoundingClientRect();
                                const b = items[1].getBoundingClientRect();
                                deltaX = Math.max(1, b.left - a.left); // include gap implicitly
                            } else {
                                deltaX = 0;
                            }
                        }
                        function applyTransform(withTransition = true) {
                            trackEl.style.transition = withTransition ? `transform ${TRANSITION_MS}ms cubic-bezier(0.22, 1, 0.36, 1)` : 'none';
                            trackEl.style.transform = `translateX(${-step * deltaX}px)`;
                        }

                        measureDelta();
                        applyTransform(false);

                        // Handle resize: re-render if visible count changes, else recompute
                        window.topStripResizeHandler = () => {
                            const newVisible = Math.min(getTopVisible(), topTools.length);
                            if (typeof window.topStripLastVisible === 'number' && window.topStripLastVisible !== newVisible) {
                                renderTopStrip();
                                return;
                            }
                            measureDelta();
                            applyTransform(false);
                        };
                        window.addEventListener('resize', window.topStripResizeHandler);
                        window.topStripLastVisible = visible;

                        function forwardOne() {
                            step += 1;
                            applyTransform(true);
                            if (step === topTools.length) {
                                setTimeout(() => {
                                    step = 0;
                                    applyTransform(false);
                                    void trackEl.offsetHeight;
                                    trackEl.style.transition = `transform ${TRANSITION_MS}ms ease`;
                                }, TRANSITION_MS + 20);
                            }
                        }
                        function backwardOne() {
                            if (step === 0) {
                                // jump to clone end without transition, then step back with transition for seamless prev
                                step = topTools.length;
                                applyTransform(false);
                                void trackEl.offsetHeight;
                            }
                            step = (step - 1 + topTools.length) % topTools.length;
                            applyTransform(true);
                        }

                        function startRotation() {
                            if (!topTools || topTools.length <= visible) return; // no rotation needed
                            window.topStripInterval = setInterval(() => {
                                if (!document.body.contains(topStripEl)) { clearInterval(window.topStripInterval); window.topStripInterval = null; return; }
                                forwardOne();
                            }, STEP_MS);
                        }

                        // Pause on hover
                        containerEl.addEventListener('mouseenter', () => { if (window.topStripInterval) { clearInterval(window.topStripInterval); window.topStripInterval = null; } });
                        containerEl.addEventListener('mouseleave', () => { if (!window.topStripInterval && !isDragging) startRotation(); });

                        // Drag-to-scroll with snap (pointer events only; touch supported)
                        if (viewportEl) {
                            const onPointerDown = (e) => {
                                isDragging = true; didDrag = false; dragDx = 0; stepAtDown = step;
                                dragStartX = e.clientX || (e.touches && e.touches[0]?.clientX) || 0;
                                viewportEl.style.cursor = 'grabbing';
                                if (window.topStripInterval) { clearInterval(window.topStripInterval); window.topStripInterval = null; }
                            };
                            const onPointerMove = (e) => {
                                if (!isDragging) return;
                                const x = e.clientX || (e.touches && e.touches[0]?.clientX) || 0;
                                dragDx = x - dragStartX;
                                if (Math.abs(dragDx) > 3) didDrag = true;
                                const base = stepAtDown * deltaX;
                                trackEl.style.transition = 'none';
                                trackEl.style.transform = `translateX(${-(base - dragDx)}px)`;
                            };
                            const onPointerUp = () => {
                                if (!isDragging) return;
                                isDragging = false;
                                viewportEl.style.cursor = 'grab';
                                // snap to nearest item
                                const shift = Math.round(dragDx / deltaX);
                                let newStep = stepAtDown - shift;
                                newStep = Math.max(0, Math.min(topTools.length, newStep));
                                step = newStep;
                                applyTransform(true);
                                // If movement was significant, mark that a drag occurred to suppress click
                                didDrag = Math.abs(dragDx) > 3;
                                // resume rotation after short delay
                                setTimeout(() => { if (!window.topStripInterval) startRotation(); }, 1200);
                            };
                            // Pointer events (also cover touch on modern browsers)
                            viewportEl.addEventListener('pointerdown', onPointerDown);
                            viewportEl.addEventListener('pointermove', onPointerMove);
                            viewportEl.addEventListener('pointerup', onPointerUp);
                            viewportEl.addEventListener('pointercancel', onPointerUp);
                            // Ensure vertical scroll still works while allowing horizontal drag
                            try { viewportEl.style.touchAction = 'pan-y'; } catch {}
                        }

                        // Start
                        startRotation();
                    }

                    // initial render
                    renderTopStrip();

                    // Ensure any stale filter UI is hidden on render
                    try {
                        const staleMenu = document.getElementById('filter-menu');
                        const staleBackdrop = document.getElementById('filter-backdrop');
                        if (staleMenu) staleMenu.classList.add('hidden');
                        if (staleBackdrop) { staleBackdrop.style.display = 'none'; staleBackdrop.style.pointerEvents = 'none'; }
                        window.addEventListener('orientationchange', () => {
                            const bd = document.getElementById('filter-backdrop');
                            const mm = document.getElementById('filter-menu');
                            if (bd) { bd.style.display = 'none'; bd.style.pointerEvents = 'none'; }
                            if (mm) mm.classList.add('hidden');
                        });
                    } catch {}

                    // Reattach listeners for domain grid cards
                    attachDomainCardListeners();

                    function computeCategoryCounts(matches) {
                        const counts = { all: 0 };
                        const list = matches && matches.length ? matches : (db || []).flatMap(d => (d.tools||[]));
                        for (const d of (db || [])) counts[d.slug] = 0;
                        for (const t of list) {
                            const slug = toolDomainMap.get(t.name) || '';
                            counts.all++;
                            if (slug && slug in counts) counts[slug]++;
                        }
                        return counts;
                    }

                    function renderFilterMenu(matches) {
                        const menu = document.getElementById('filter-menu');
                        const btn = document.getElementById('filter-button');
                        if (!menu || !btn) return;
                        const debugOn = (() => {
                            try { const url = new URL(window.location.href); if (url.searchParams.get('debugFilter') === '1') return true; } catch {}
                            try { if (localStorage.getItem('debugFilter') === '1') return true; } catch {}
                            return false;
                        })();
                        const dbg = (...args) => { if (!debugOn) return; try { console.debug('[filter]', ...args); } catch {} };
                        if (debugOn && !document.getElementById('debug-filter-log')) {
                            const box = document.createElement('div');
                            box.id = 'debug-filter-log';
                            box.style.cssText = 'position:fixed;left:6px;bottom:6px;right:6px;max-height:30vh;overflow:auto;background:rgba(0,0,0,0.6);color:#fff;font:12px/1.4 monospace;z-index:2000;padding:6px;border-radius:8px;';
                            box.textContent = 'Filter debug on. Add ?debugFilter=0 to disable.';
                            document.body.appendChild(box);
                        }
                        const logBox = () => document.getElementById('debug-filter-log');
                        const log = (msg) => { if (!debugOn) return; dbg(msg); const el = logBox(); if (el) { const p = document.createElement('div'); p.textContent = msg; el.appendChild(p); el.scrollTop = el.scrollHeight; } };
                        // Ensure menu is scrollable by default
                        try { menu.style.overflowY = 'auto'; menu.style.pointerEvents = 'auto'; menu.style.touchAction = 'pan-y'; } catch {}
                        const counts = computeCategoryCounts(matches);
                        const current = state.selectedCategory || 'all';
                        const itemHtml = [];
                        itemHtml.push(`<div class="px-3 py-2 text-xs font-semibold text-secondary">Categories</div>`);
                        // All option
                        itemHtml.push(`<button class="w-full text-left px-4 py-2 hover:bg-purple-50 dark:hover:bg-purple-900/20 ${current==='all'?'bg-purple-50 dark:bg-purple-900/10':''}" data-value="all">All (${counts.all || 0})</button>`);
                        // Category options
                        for (const d of getOrderedDomains()) {
                            const c = counts[d.slug] || 0;
                            const active = current === d.slug ? 'bg-purple-50 dark:bg-purple-900/10' : '';
                            itemHtml.push(`<button class="w-full text-left px-4 py-2 hover:bg-purple-50 dark:hover:bg-purple-900/20 ${active}" data-value="${d.slug}">${escapeHtml(d.name)} (${c})</button>`);
                        }
                        // Close action
                        itemHtml.push(`<div class="flex items-center justify-end px-3 py-2 border-t border-color">
                            <button class="text-sm bg-purple-600 text-white px-3 py-1 rounded" data-action="close">Done</button>
                        </div>`);
                        menu.innerHTML = itemHtml.join('');

                        // Wire item clicks
                        menu.querySelectorAll('button[data-value]').forEach(el => {
                            const handler = (e) => {
                                const val = e.currentTarget.getAttribute('data-value') || 'all';
                                if (val === 'all') {
                                    state.categoryExplicit = false;
                                    state.selectedCategory = 'all';
                                    searchPage = 1;
                                    renderSearchResults();
                                    hideMenu();
                                    renderFilterMenu(currentMatchesCache);
                                } else {
                                    state.categoryExplicit = true;
                                    const slug = val;
                                    state.selectedCategory = slug;
                                    if (!state.searchQuery.trim() && slug !== 'all') {
                                        state.selectedDomain = slug;
                                        state.currentView = 'tools';
                                        hideMenu();
                                        render();
                                        return; // render() will rebuild menu
                                    } else {
                                        searchPage = 1;
                                        renderSearchResults();
                                        hideMenu();
                                        renderFilterMenu(currentMatchesCache);
                                    }
                                }
                            };
                            el.onclick = handler;
                            // Add touch support for mobile
                            el.addEventListener('touchend', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                handler(e);
                            }, { passive: false });
                        });
                        const closeBtn = menu.querySelector('button[data-action="close"]');
                        if (closeBtn) {
                            closeBtn.onclick = () => toggleFilterMenu(false);
                            closeBtn.addEventListener('touchend', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                toggleFilterMenu(false);
                            }, { passive: false });
                        }

                        // Button toggle
                        const ensureBackdrop = () => {
                            let bd = document.getElementById('filter-backdrop');
                            if (!bd) {
                                bd = document.createElement('div');
                                bd.id = 'filter-backdrop';
                                bd.style.display = 'none';
                                document.body.appendChild(bd);
                                // Handle both click and touch events for closing
                                bd.addEventListener('click', () => { hideMenu(); });
                                bd.addEventListener('touchend', (e) => { 
                                    e.preventDefault(); 
                                    e.stopPropagation(); 
                                    hideMenu(); 
                                }, { passive: false });
                            }
                            return bd;
                        };
                        const showBackdrop = () => { const bd = ensureBackdrop(); bd.style.display = 'block'; bd.style.pointerEvents = 'auto'; log('backdrop: show'); };
                        const hideBackdrop = () => { const bd = document.getElementById('filter-backdrop'); if (bd) { bd.style.display = 'none'; bd.style.pointerEvents = 'none'; log('backdrop: hide'); } };
                        const hideMenu = () => {
                            menu.classList.add('hidden'); hideBackdrop();
                            if (window.filterMenuResizeHandler) { window.removeEventListener('resize', window.filterMenuResizeHandler); window.filterMenuResizeHandler = null; }
                            if (window.filterMenuScrollHandler) { window.removeEventListener('scroll', window.filterMenuScrollHandler, true); window.filterMenuScrollHandler = null; }
                        };
                        const portalMenuToBody = () => {
                            try {
                                if (menu.parentElement !== document.body) {
                                    document.body.appendChild(menu);
                                }
                                menu.style.position = 'fixed';
                                menu.style.zIndex = '1000';
                                menu.style.pointerEvents = 'auto';
                                menu.style.touchAction = 'pan-y';
                                log('menu: portaled to body');
                            } catch {}
                        };
                        const positionMenuNearButton = () => {
                            try {
                                const r = btn.getBoundingClientRect();
                                const margin = 8;
                                const vw = window.innerWidth || document.documentElement.clientWidth || 0;
                                const right = Math.max(8, vw - r.right - 8);
                                const top = Math.max(8, r.bottom + margin);
                                menu.style.top = `${top}px`;
                                menu.style.right = `${right}px`;
                                menu.style.left = 'auto';
                                log(`menu: position top=${top} right=${right}`);
                            } catch {}
                        };
                        const sizeMenuToAvailableSpace = () => {
                            try {
                                const anchor = document.getElementById('domain-tiles-anchor');
                                // Temporarily ensure visible for accurate measurement
                                const prev = menu.classList.contains('hidden');
                                if (prev) menu.classList.remove('hidden');
                                const menuRect = menu.getBoundingClientRect();
                                const viewportBottom = window.innerHeight || document.documentElement.clientHeight || 0;
                                let limitPx = Math.min(viewportBottom - menuRect.top - 16, (viewportBottom * 0.6));
                                if (anchor) {
                                    const anchorRect = anchor.getBoundingClientRect();
                                    const spaceToAnchor = anchorRect.top - menuRect.top - 12; // keep a small gap
                                    if (Number.isFinite(spaceToAnchor)) {
                                        limitPx = Math.min(limitPx, spaceToAnchor);
                                    }
                                }
                                const minPx = 140; // allow at least a few items
                                const finalPx = Math.max(minPx, limitPx);
                                menu.style.maxHeight = `${finalPx}px`;
                                log(`menu: size maxHeight=${finalPx}`);
                                if (prev) menu.classList.add('hidden');
                            } catch {}
                        };
                        let menuOpenedAt = 0;
                        const toggleFilterMenu = (force) => {
                            const shouldShow = typeof force === 'boolean' ? force : menu.classList.contains('hidden');
                            if (shouldShow) {
                                portalMenuToBody();
                                positionMenuNearButton();
                                menu.classList.remove('hidden'); log('menu: show');
                                showBackdrop();
                                // Mobile-friendly width cap
                                try { menu.style.maxWidth = 'min(90vw, 20rem)'; } catch {}
                                sizeMenuToAvailableSpace();
                                // Recompute on viewport changes
                                if (window.filterMenuResizeHandler) { window.removeEventListener('resize', window.filterMenuResizeHandler); }
                                window.filterMenuResizeHandler = () => { positionMenuNearButton(); sizeMenuToAvailableSpace(); };
                                window.addEventListener('resize', window.filterMenuResizeHandler);
                                if (window.filterMenuScrollHandler) { window.removeEventListener('scroll', window.filterMenuScrollHandler, true); }
                                window.filterMenuScrollHandler = () => { positionMenuNearButton(); sizeMenuToAvailableSpace(); };
                                window.addEventListener('scroll', window.filterMenuScrollHandler, true);
                                // Ensure wheel/touch scrolling works within the dropdown
                                try {
                                    if (window.filterMenuWheelHandler) { menu.removeEventListener('wheel', window.filterMenuWheelHandler); }
                                    window.filterMenuWheelHandler = (evt) => { evt.stopPropagation(); };
                                    menu.addEventListener('wheel', window.filterMenuWheelHandler, { passive: true });
                                    if (window.filterMenuTouchHandler) { menu.removeEventListener('touchmove', window.filterMenuTouchHandler); }
                                    window.filterMenuTouchHandler = (evt) => { /* allow native scrolling but keep events inside */ };
                                    menu.addEventListener('touchmove', window.filterMenuTouchHandler, { passive: true });
                                } catch {}
                                menuOpenedAt = Date.now(); log('menu: opened');
                            } else {
                                log('menu: hide request'); hideMenu();
                            }
                        };
                        // Attach button handlers once per render (mobile friendly)
                        let lastOpenIntent = 0;
                        const openHandler = (e) => {
                            try { e.stopPropagation(); } catch {}
                            if (e.type === 'pointerdown') { try { e.preventDefault(); } catch {} }
                            const now = Date.now();
                            if (now - lastOpenIntent < 300) return; // debounce duplicate pointer/touch/click
                            lastOpenIntent = now;
                            log(`btn: ${e.type}`);
                            toggleFilterMenu(true); // force open; avoid toggle-close on duplicate events
                        };
                        // Simple click handler works for most cases
                        btn.onclick = openHandler;
                        
                        // For touch devices, use touchend for better reliability
                        try {
                            btn.addEventListener('touchend', (te) => {
                                try { 
                                    te.preventDefault(); 
                                    te.stopPropagation(); 
                                } catch {}
                                openHandler(te);
                            }, { passive: false });
                        } catch {}
                        
                        // Keyboard accessibility
                        try { btn.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { ev.preventDefault(); openHandler(ev); } }); } catch {}
                        
                        // Prevent interactions inside the menu from bubbling to the document handler
                        try {
                            menu.addEventListener('click', (ev)=>ev.stopPropagation());
                            menu.addEventListener('mousedown', (ev)=>ev.stopPropagation());
                            menu.addEventListener('touchstart', (ev)=>ev.stopPropagation(), { passive: true });
                            menu.addEventListener('touchend', (ev)=>ev.stopPropagation(), { passive: true });
                        } catch {}

                        // Outside click/escape to close
                        if (window.filterOutsideClick) {
                            document.removeEventListener('click', window.filterOutsideClick);
                            window.filterOutsideClick = null;
                        }
                        window.filterOutsideClick = (ev) => {
                            const mm = document.getElementById('filter-menu');
                            const unit = document.getElementById('search-filter-unit');
                            if (!mm || !unit) return;
                            const target = ev.target;
                            const insideMenu = mm.contains(target);
                            const insideUnit = unit.contains(target);
                            // Ignore the very first click right after opening (mobile safety / portrait tap)
                            if (!insideMenu && !insideUnit) {
                                if (typeof menuOpenedAt === 'number' && Date.now() - menuOpenedAt < 350) return;
                                hideMenu();
                            }
                        };
                        document.addEventListener('click', window.filterOutsideClick);
                        if (window.filterEscapeHandler) {
                            document.removeEventListener('keydown', window.filterEscapeHandler);
                            window.filterEscapeHandler = null;
                        }
                        window.filterEscapeHandler = (ev) => {
                            if (ev.key === 'Escape') {
                                hideMenu();
                            }
                        };
                        document.addEventListener('keydown', window.filterEscapeHandler);
                    }

                    let currentMatchesCache = [];
                    let searchPage = 1; // local page state within renderHome scope
                    const PAGE_SIZE = 5;
                    function renderSearchResults() {
                        const q = (state.searchQuery || '').trim();
                        if (!q) { resultsContainer.innerHTML = ''; return; }
                        const matches = performSearch(q);
                        currentMatchesCache = matches.slice();
                        // Apply category filter if selected
                        const filteredByCat = (state.selectedCategory && state.selectedCategory !== 'all')
                            ? matches.filter(t => (toolDomainMap.get(t.name) || '') === state.selectedCategory)
                            : matches;
                        if (!matches || matches.length === 0) {
                            resultsContainer.innerHTML = `<div class="text-secondary">No tools found for "<strong>${escapeHtml(q)}</strong>". Try different keywords.</div>`;
                            return;
                        }
                        // pagination calculations
                        const total = filteredByCat.length;
                        const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
                        if (searchPage > totalPages) searchPage = totalPages;
                        const start = (searchPage - 1) * PAGE_SIZE;
                        const end = start + PAGE_SIZE;
                        const pageItems = filteredByCat.slice(start, end);

                        resultsContainer.innerHTML = `
                            <div class="mb-3 md:mb-4 flex items-center justify-between px-1">
                                <h3 class="text-xl font-semibold">Matching Tools</h3>
                                <div class="text-sm text-secondary">${start + 1}-${Math.min(end, total)} of ${total}</div>
                            </div>
                            <div class="search-results" role="list">${pageItems.map(renderSearchTile).join('')}</div>
                            <div class="flex items-center justify-end gap-2 mt-3 pr-1">
                                <button class="pager-btn" id="prev-page" ${searchPage<=1?'disabled':''} aria-label="Previous">◀</button>
                                <span class="text-sm text-secondary">Page ${searchPage} / ${totalPages}</span>
                                <button class="pager-btn" id="next-page" ${searchPage>=totalPages?'disabled':''} aria-label="Next">▶</button>
                            </div>`;
                        // attach handlers for clickable logos to open modal
                        resultsContainer.querySelectorAll('.open-tool-logo').forEach(img => {
                            img.addEventListener('click', (e) => {
                                e.preventDefault();
                                const parent = e.currentTarget.closest('[data-name]');
                                const name = parent ? parent.getAttribute('data-name') : e.currentTarget.getAttribute('data-name');
                                if (name) openToolByName(name);
                            });
                        });
                        const prev = resultsContainer.querySelector('#prev-page');
                        const next = resultsContainer.querySelector('#next-page');
                        if (prev) prev.onclick = () => { if (searchPage > 1) { searchPage--; renderSearchResults(); } };
                        if (next) next.onclick = () => { if (searchPage < totalPages) { searchPage++; renderSearchResults(); } };
                        // Refresh filter menu with match-based counts
                        renderFilterMenu(matches);
                    }
                    if (sb) {
                        sb.addEventListener('input', (e) => {
                            state.searchQuery = e.target.value;
                            searchPage = 1;
                            renderSearchResults();
                            // When typing, refresh filter menu with counts for the current matches
                            renderFilterMenu(currentMatchesCache);
                        });
                        sb.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') e.preventDefault();
                        });
                    }
                    // Clear button removed; reset handled on navigation only

                    // Initial filter menu render (no query -> total counts)
                    renderFilterMenu([]);
                    attachDomainCardListeners();
                },
                renderTools: () => {
                    const domain = db.find(d => d.slug === state.selectedDomain);
                    if (!domain) { originalRenderFunctions.renderHome(); return; }

                    const domainTools = (domain.tools || []).filter(t => !isExcludedTool(t));

                    // Helper: compute a comparable popularity "rank" number (smaller = more popular).
                    // Prefers explicit popularityRanksMap, then derives rank from Most Popular order.
                    const mpValuesSorted = Object.values(mostPopularOrderMap || {}).sort((a,b)=>b-a);
                    function getPopularityRankNumber(tool){
                        const key = String(tool?.name || '').trim().toLowerCase();
                        const directRank = Number(popularityRanksMap && popularityRanksMap[key] || 0);
                        if (directRank > 0) return directRank;
                        const score = Number(mostPopularOrderMap && mostPopularOrderMap[key] || 0);
                        if (score > 0) {
                            const idx = mpValuesSorted.indexOf(score);
                            if (idx >= 0) return idx + 1; // 1-based rank
                        }
                        return Number.POSITIVE_INFINITY; // unknown rank
                    }
                    function compareByPopularityRankAsc(a, b){
                        const ra = getPopularityRankNumber(a);
                        const rb = getPopularityRankNumber(b);
                        if (ra !== rb) return ra - rb; // smaller rank first
                        // Fallbacks: higher users count first, then Most Popular order score, then alphabetical
                        const ua = getUsersCount(a) || 0;
                        const ub = getUsersCount(b) || 0;
                        if (ua !== ub) return ub - ua; // higher users first
                        const ka = String(a?.name||'').trim().toLowerCase();
                        const kb = String(b?.name||'').trim().toLowerCase();
                        const sa = Number(mostPopularOrderMap && mostPopularOrderMap[ka] || 0);
                        const sb = Number(mostPopularOrderMap && mostPopularOrderMap[kb] || 0);
                        if (sa !== sb) return sb - sa; // higher MP score first
                        return ka < kb ? -1 : ka > kb ? 1 : 0;
                    }

                    // Helper to render a vertical list of tools in a single card.
                    // NOTE: Empty groups are no longer rendered at all to avoid grid gaps & "jumbled" ordering.
                    function renderGroupCard(title, tools, color, totalCount) {
                        const countBadge = ` <span class=\"text-sm font-semibold text-secondary\">(${totalCount})</span>`;
                        return `
                            <div class="pricing-group bg-card border border-color rounded-xl p-4 flex flex-col">
                                <h3 class="text-xl font-bold mb-3 flex items-center gap-2" style="color:${color}">${title}${countBadge}</h3>
                                <ul class="flex flex-col gap-3">
                                    ${tools.map(tool => {
                                        const toolId = tool.name;
                                        const isFav = state.favorites.includes(toolId);
                                        return `
                                        <li class="tool-list-item card-hover-effect p-3 cursor-pointer" data-tool-name="${escapeHtml(tool.name)}" data-domain-slug="${escapeHtml(domain.slug)}">
                                            <div class="flex items-center gap-3 flex-1 min-w-0">
                                                ${iconImgHtml(tool, 40, 'flex-shrink-0')}
                                                <div class="min-w-0">
                                                    <div class="text-lg font-bold text-primary">${escapeHtml(tool.name)} ${usersBadgeHtml(tool)}</div>
                                                    <div class="text-sm text-secondary tool-desc-line">
                                                        ${escapeHtml((tool.description || '').split('.')[0])}
                                                        <span class="show-more-desc text-purple-600 cursor-pointer ml-2 underline text-xs">Show more</span>
                                                    </div>
                                                    <div class="text-sm text-secondary tool-desc-full hidden mt-1">${escapeHtml(tool.description || '')} <span class="show-less-desc text-purple-600 cursor-pointer ml-2 underline text-xs">Show less</span></div>
                                                    <div class="flex flex-wrap gap-1 mt-1">
                                                        ${(tool.tags||[]).slice(0, 4).map(tag => `<span class=\"text-xs tag px-2 py-1 rounded-full whitespace-nowrap\">${escapeHtml(tag)}</span>`).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex flex-col items-end gap-2 ml-4">
                                                <button class="favorite-btn px-2 py-1 rounded border text-sm ${isFav ? 'bg-yellow-300' : 'bg-secondary'}" data-tool-id="${toolId}" title="Favorite">${isFav ? '★' : '☆'}</button>
                                                <button class="px-3 py-1 rounded border text-sm open-tool-btn" data-name="${escapeHtml(tool.name)}">Open</button>
                                                <a href="${tool.link || '#'}" target="_blank" class="bg-purple-600 text-white px-3 py-1 rounded text-sm">Visit</a>
                                            </div>
                                        </li>
                                        `;
                                    }).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    // For GitHub AI Projects, relax grouping to tag-based 4 custom groups so items don't disappear due to pricing tags
                    let groupData;
                    if (domain.slug === 'github-ai-projects') {
                        const normalize = (arr) => (Array.isArray(arr) ? arr : []).map(x => String(x).toLowerCase());
                        const byTag = {
                            frameworks: [],
                            agents: [],
                            models: [],
                            utilities: []
                        };
                        for (const t of domainTools) {
                            const tags = normalize(t.tags);
                            const name = String(t.name || '').toLowerCase();
                            const desc = String(t.description || '').toLowerCase();
                            const text = tags.join(' ') + ' ' + name + ' ' + desc;
                            if (/(framework|sdk|library|toolkit|api|package|plugin)/i.test(text)) {
                                byTag.frameworks.push(t);
                            } else if (/(agent|agents|orchestr|workflow|automation|assistant|autonomous)/i.test(text)) {
                                byTag.agents.push(t);
                            } else if (/(llm|model|inference|transformer|diffusion|vision|speech|tts|asr|nlp)/i.test(text)) {
                                byTag.models.push(t);
                            } else {
                                byTag.utilities.push(t);
                            }
                        }
                        groupData = [
                            { title: 'Frameworks & SDKs', tools: byTag.frameworks.slice().sort(compareByPopularityRankAsc), color: '#0ea5e9' },
                            { title: 'Agents & Orchestration', tools: byTag.agents.slice().sort(compareByPopularityRankAsc), color: '#7c3aed' },
                            { title: 'Models & Inference', tools: byTag.models.slice().sort(compareByPopularityRankAsc), color: '#059669' },
                            { title: 'Apps & Utilities', tools: byTag.utilities.slice().sort(compareByPopularityRankAsc), color: '#f59e0b' }
                        ];
                    } else {
                        // Default pricing-based grouping for other domains
                        const openSource = (domainTools || []).filter(t => (t.tags||[]).some(tag => /(^oss$)|open[\s-]?source/i.test(String(tag).toLowerCase())));
                        const free = (domainTools || []).filter(t =>
                            !(t.tags||[]).some(tag => /open ?source|freemium|paid|subscription|enterprise/i.test(tag)) &&
                            ((t.tags||[]).some(tag => /free/i.test(tag)) || (t.price && t.price.toLowerCase() === 'free'))
                        );
                        const freemium = (domainTools || []).filter(t =>
                            (t.tags||[]).some(tag => /freemium/i.test(String(tag))) &&
                            !(t.tags||[]).some(tag => /(^oss$)|open[\s-]?source/i.test(String(tag).toLowerCase()))
                        );
                        const paid = (domainTools || []).filter(t =>
                            (t.tags||[]).some(tag => /paid|subscription|subscribe|premium|enterprise/i.test(String(tag))) &&
                            !(t.tags||[]).some(tag => /freemium|free|(^oss$)|open[\s-]?source/i.test(String(tag).toLowerCase()))
                        );
                        groupData = [
                            { title: 'Free', tools: free.slice().sort(compareByPopularityRankAsc), color: '#22d3ee' },
                            { title: 'Freemium', tools: freemium.slice().sort(compareByPopularityRankAsc), color: '#6366f1' },
                            { title: 'Paid/Subscription', tools: paid.slice().sort(compareByPopularityRankAsc), color: '#f59e42' },
                            { title: 'Open Source', tools: openSource.slice().sort(compareByPopularityRankAsc), color: '#10b981' }
                        ];
                    }

                    // Only render non-empty groups to prevent layout gaps.
                    const nonEmptyGroups = groupData.filter(g => g.tools.length > 0);
                    // If all groups are empty (edge case), show all tools under Utilities as fallback
                    const effectiveGroups = nonEmptyGroups.length > 0 ? nonEmptyGroups : [{ title: 'All Tools', tools: domainTools.slice().sort(compareByPopularityRankAsc), color: '#6b7280' }];
                    const groupCards = effectiveGroups.map(g => {
                        const sorted = (g.tools || []).slice().sort(compareByPopularityRankAsc);
                        return renderGroupCard(g.title, sorted, g.color, g.tools.length);
                    }).join('');
                    const groupCount = Math.max(1, Math.min(effectiveGroups.length || 1, 4));
                    const gridColsClass = groupCount === 1 ? 'grid-cols-1' : groupCount === 2 ? 'grid-cols-1 sm:grid-cols-2' : groupCount === 3 ? 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3' : 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-4';

                    contentArea.innerHTML = `
                        <div class="mb-8">
                            <button id="back-button" class="flex items-center text-purple-600 hover:text-purple-700 transition mb-4">
                                <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                                Back to Domains
                            </button>
                            <div class="flex items-center space-x-4">
                                <span class="text-purple-500">${domain.icon}</span>
                                <div><h1 class="text-4xl font-bold text-primary">${domain.name}</h1><p class="text-secondary mt-1">${domain.description}</p></div>
                            </div>
                        </div>
                        <div class="grid ${gridColsClass} gap-6 items-start">
                            ${groupCards || '<div class="text-muted text-sm">No tools found in this domain.</div>'}
                        </div>
                    `;
                    document.getElementById('back-button').addEventListener('click', () => { 
                        state.currentView = 'home'; 
                        // Reset category to placeholder when navigating back
                        state.selectedCategory = 'all';
                        state.categoryExplicit = false;
                        try { history.pushState('', document.title, window.location.pathname + window.location.search); } catch (e) {}
                        render(); 
                    });
                    attachToolItemListeners();
                    // Favorite button event wiring
                    document.querySelectorAll('.favorite-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const toolId = e.currentTarget.getAttribute('data-tool-id');
                            const idx = state.favorites.indexOf(toolId);
                            if (idx === -1) {
                                state.favorites.push(toolId);
                            } else {
                                state.favorites.splice(idx, 1);
                            }
                            render(); // Update UI immediately
                            // Save to Firestore in background
                            saveFavoritesToFirestore().catch(console.error);
                        });
                    });
                },
                renderAbout: () => {
                     contentArea.innerHTML = `
                        <div class="max-w-4xl mx-auto text-center mb-16">
                            <h1 class="text-4xl md:text-5xl font-bold text-primary mb-4">Our Mission</h1>
                            <p class="text-lg md:text-xl text-secondary">To build the most beautiful, curated, and developer-focused directory for AI tools.</p>
                        </div>
                        <div class="max-w-5xl mx-auto grid md:grid-cols-3 gap-8 text-left">
                            <div class="feature-card">
                                <div class="p-3 bg-purple-100 dark:bg-purple-900/20 rounded-full inline-block mb-4"><svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                                <h3 class="text-lg font-semibold text-primary mb-2">Curated & Vetted</h3>
                                <p class="text-secondary text-sm">Every tool is hand-picked and accurately classified. We focus on quality over quantity to ensure you find only the most relevant and effective solutions.</p>
                            </div>
                            <div class="feature-card">
                                <div class="p-3 bg-purple-100 dark:bg-purple-900/20 rounded-full inline-block mb-4"><svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></div>
                                <h3 class="text-lg font-semibold text-primary mb-2">Design-Centric</h3>
                                <p class="text-secondary text-sm">We believe a good tool directory should be a pleasure to use. Our UI is clean, modern, and built with the high standards of developers and designers in mind.</p>
                            </div>
                            <div class="feature-card">
                                <div class="p-3 bg-purple-100 dark:bg-purple-900/20 rounded-full inline-block mb-4"><svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg></div>
                                <h3 class="text-lg font-semibold text-primary mb-2">Actionable Information</h3>
                                <p class="text-secondary text-sm">Get what you need, fast. Each listing provides a direct link, a concise description, and key tags so you can make informed decisions quickly.</p>
                            </div>
                        </div>
                    `;
                },
                renderSubmit: () => {
                    contentArea.innerHTML = `
                        <div class="max-w-2xl mx-auto">
                            <div class="text-center mb-10">
                                <h1 class="text-4xl font-bold text-primary mb-4">Submit a Tool</h1>
                                <p class="text-secondary">Help the community by submitting a tool. Our team will review it for inclusion.</p>
                            </div>
                            <form id="submit-tool-form" class="space-y-6 bg-card p-8 rounded-lg border border-color">
                                <div>
                                    <label for="tool-name" class="block text-sm font-medium text-secondary">Tool Name</label>
                                    <input type="text" id="tool-name" class="mt-1 block w-full bg-secondary border-color rounded-md shadow-sm py-2 px-3 text-primary focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                </div>
                                <div>
                                    <label for="tool-link" class="block text-sm font-medium text-secondary">Tool Website Link</label>
                                    <input type="url" id="tool-link" class="mt-1 block w-full bg-secondary border-color rounded-md shadow-sm py-2 px-3 text-primary focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                </div>
                                <div>
                                    <label for="tool-domain" class="block text-sm font-medium text-secondary">Primary Domain</label>
                                    <select id="tool-domain" class="mt-1 block w-full bg-secondary border-color rounded-md shadow-sm py-2 px-3 text-primary focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                        ${ (db || []).map(d => `<option>${d.name}</option>`).join('') }
                                    </select>
                                </div>
                                <div>
                                    <label for="tool-desc" class="block text-sm font-medium text-secondary">Short Description</label>
                                    <textarea id="tool-desc" rows="3" class="mt-1 block w-full bg-secondary border-color rounded-md shadow-sm py-2 px-3 text-primary focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                                </div>
                                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition">Submit for Review</button>
                                <div id="submit-status" class="text-sm mt-3 text-secondary"></div>
                            </form>
                        </div>
                    `;
                    const form = contentArea.querySelector('#submit-tool-form');
                    const statusEl = contentArea.querySelector('#submit-status');
                    if (form) {
                        form.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            statusEl.textContent = 'Submitting...';
                            const name = contentArea.querySelector('#tool-name').value.trim();
                            const link = contentArea.querySelector('#tool-link').value.trim();
                            const domainName = contentArea.querySelector('#tool-domain').value.trim();
                            const desc = contentArea.querySelector('#tool-desc').value.trim();
                            if (!name || !link || !domainName) { statusEl.textContent = 'Please fill required fields.'; return; }
                            try {
                                const payload = {
                                    title: name,
                                    link,
                                    domain: domainName,
                                    description: desc,
                                    status: 'pending',
                                    createdAt: new Date(),
                                    createdBy: state.user?.email || state.user?.uid || 'anonymous',
                                    submitterEmail: state.user?.email || ''
                                };
                                // Create a submission document; server timestamps preferred but acceptable here.
                                const subRef = doc(collection(firestore, 'submissions'));
                                await setDoc(subRef, payload);
                                // Email notifications disabled (Netlify removed). Admin can review in Firestore.
                                statusEl.textContent = 'Thanks! Your submission was received.';
                                form.reset();
                            } catch (err) {
                                console.error(err);
                                statusEl.textContent = 'There was a problem submitting your tool.';
                            }
                        });
                    }
                }
            };

            const render = () => {
                const isDark = document.documentElement.classList.contains('dark');
                document.body.classList.toggle('dark-mode-bg', isDark);
                document.body.classList.toggle('light-mode-bg', !isDark);
                switch (state.currentView) {
                    case 'tools': originalRenderFunctions.renderTools(); break;
                    case 'submit': originalRenderFunctions.renderSubmit(); break;
                    case 'about': originalRenderFunctions.renderAbout(); break;
                    case 'admin': renderAdmin(); break;
                    case 'favorites': renderFavorites(); break;
                    default: originalRenderFunctions.renderHome(); break;
                }
                // Add/Update My Favorites link after user info
                const favLinkContainer = ensureFavoritesLinkContainer();
                if (state.user) {
                    favLinkContainer.innerHTML = `<button id="favorites-link" class="ml-2 px-3 py-1 rounded bg-purple-100 text-purple-700 font-semibold hover:bg-purple-200 transition flex items-center gap-1"><svg class='w-5 h-5 text-purple-500' fill='none' stroke='currentColor' viewBox='0 0 24 24'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M11.049 2.927c.3-.921 1.603-.921 1.902 0l2.036 6.29a1 1 0 00.95.69h6.631c.969 0 1.371 1.24.588 1.81l-5.37 3.905a1 1 0 00-.364 1.118l2.036 6.29c.3.921-.755 1.688-1.538 1.118l-5.37-3.905a1 1 0 00-1.175 0l-5.37 3.905c-.783.57-1.838-.197-1.538-1.118l2.036-6.29a1 1 0 00-.364-1.118L2.342 11.717c-.783-.57-.38-1.81.588-1.81h6.631a1 1 0 00.95-.69l2.036-6.29z'/></svg>My Favorites</button>`;
                    document.getElementById('favorites-link').onclick = () => {
                        state.currentView = 'favorites';
                        render();
                    };
                    const adminContainer = ensureAdminLinkContainer();
                    if (state.isAdmin) {
                        adminContainer.innerHTML = `<button id="admin-link" class="ml-2 px-3 py-1 rounded bg-emerald-100 text-emerald-800 font-semibold hover:bg-emerald-200 transition">Admin</button>`;
                        document.getElementById('admin-link').onclick = () => { state.currentView = 'admin'; render(); };
                    } else {
                        adminContainer.innerHTML = '';
                    }
                } else {
                    favLinkContainer.innerHTML = '';
                    const adminContainer = ensureAdminLinkContainer();
                    adminContainer.innerHTML = '';
                }
                // Re-attach theme toggle after render (in case header is re-rendered)
                if (typeof setupTheme === 'function') setupTheme();
            };

            const handleSearch = (e) => {
                state.searchQuery = e.target.value;
                originalRenderFunctions.renderHome();
            };

            const attachDomainCardListeners = () => {
                document.querySelectorAll('.domain-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        state.currentView = 'tools';
                        state.selectedDomain = e.currentTarget.dataset.slug;
                        try { location.hash = `#domain=${encodeURIComponent(state.selectedDomain)}`; } catch (e) {}
                        window.scrollTo(0, 0);
                        render();
                    });
                });
            };

            const attachToolItemListeners = () => {
                // Expand/collapse tool description
                document.querySelectorAll('.show-more-desc').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const descLine = e.target.closest('.tool-desc-line');
                        const descFull = descLine.parentElement.querySelector('.tool-desc-full');
                        descLine.style.display = 'none';
                        descFull.classList.remove('hidden');
                    });
                });
                document.querySelectorAll('.show-less-desc').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const descFull = e.target.closest('.tool-desc-full');
                        const descLine = descFull.parentElement.querySelector('.tool-desc-line');
                        descFull.classList.add('hidden');
                        descLine.style.display = '';
                    });
                });
                // Attach Open button listeners for modal
                document.querySelectorAll('.open-tool-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const toolName = e.currentTarget.getAttribute('data-name');
                        openToolByName(toolName);
                    });
                });
                // Also allow clicking the card (not the button) to open modal
                document.querySelectorAll('.tool-list-item').forEach(card => {
                    card.addEventListener('click', (e) => {
                        // Prevent modal open if a button inside the card was clicked
                        if (
                            e.target.classList.contains('open-tool-btn') ||
                            e.target.classList.contains('favorite-btn') ||
                            e.target.closest('.favorite-btn') ||
                            e.target.closest('.open-tool-btn')
                        ) return;
                        const toolName = card.dataset.toolName;
                        if (toolName) openToolByName(toolName);
                    });
                });
            };

            // Re-add theme toggle icons and listener (moved outside object)
            const themeToggleBtn = document.getElementById('theme-toggle');
            if (themeToggleBtn) {
                themeToggleBtn.innerHTML = `
                    <svg id="theme-toggle-dark-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm-.707 12.122l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414-1.414zM17 13a1 1 0 100 2h1a1 1 0 100-2h-1z" clip-rule="evenodd"></path></svg>
                `;
                setupTheme();
            }

            // --- AUTH LOGIC ---
            
            const openModal = (loginMode = true) => {
                isLoginMode = loginMode;
                modalTitle.textContent = isLoginMode ? 'Sign In' : 'Sign Up';
                authSubmitBtn.textContent = isLoginMode ? 'Sign In' : 'Sign Up';
                modalPromptText.textContent = isLoginMode ? "Don't have an account?" : "Already have an account?";
                modalSwitchBtn.textContent = isLoginMode ? 'Sign Up' : 'Sign In';
                modalError.classList.add('hidden');
                authForm.reset();
                authModal.classList.add('visible');
            };

            const closeModal = () => {
                authModal.classList.remove('visible');
            };

            const openToolDetailsModal = (tool) => {
                const logo = iconImgHtml(tool, 64, 'mr-4 flex-shrink-0');
                toolDetailsModalContent.innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <div class="flex items-start">
                            ${logo}
                            <div>
                                <h2 class="text-2xl font-bold text-primary">${tool.name} ${usersBadgeHtml(tool)}</h2>
                                <p class="text-secondary">${tool.description}</p>
                            </div>
                        </div>
                        <button id="close-tool-details-modal-btn" class="text-secondary hover:text-primary text-2xl">&times;</button>
                    </div>
                    <div class="prose max-w-none">
                        <h5 class="font-bold text-primary">About ${tool.name}</h5>
                        <p class="text-secondary">${tool.about || 'More info soon.'}</p>
                    </div>
                    <div class="mt-6 text-right">
                        <a href="${tool.link}" target="_blank" rel="noopener noreferrer" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition">Visit Website</a>
                    </div>
                `;
                toolDetailsModal.classList.add('visible');
                document.getElementById('close-tool-details-modal-btn').addEventListener('click', closeToolDetailsModal);
            };

            const closeToolDetailsModal = () => {
                toolDetailsModal.classList.remove('visible');
            };

            const handleAuthSubmit = async (e) => {
                e.preventDefault();
                const email = emailInput.value;
                const password = passwordInput.value;
                modalError.classList.add('hidden');

                try {
                    if (isLoginMode) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                    closeModal();
                } catch (error) {
                    modalError.textContent = error.message;
                    modalError.classList.remove('hidden');
                }
            };
            
            const handleGoogleSignIn = async () => {
                try {
                    await signInWithPopup(auth, provider);
                    closeModal();
                } catch (error) {
                    modalError.textContent = error.message;
                    modalError.classList.remove('hidden');
                }
            };

            const handleSignOut = async () => {
                await signOut(auth);
            };

            // --- AUTH UI RENDER ---
            function updateAuthUI(user) {
                const authContainer = document.getElementById('auth-container');
                if (!authContainer) return;
                state.user = user;
                if (user) {
                    // Show user email/uid and sign out button in header
                    const label = escapeHtml(user.email || user.uid || 'Account');
                    authContainer.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-secondary">${label}</span>
                            <button id="signout-btn" class="px-3 py-1 rounded border text-sm bg-secondary text-primary">Sign Out</button>
                        </div>
                    `;
                    const btn = document.getElementById('signout-btn');
                    if (btn) btn.addEventListener('click', handleSignOut);
                } else {
                    // Show sign in button in header
                    authContainer.innerHTML = `
                        <button id="signin-btn" class="px-3 py-1 rounded border text-base bg-purple-600 text-white hover:bg-purple-700">Sign In</button>
                    `;
                    const btn = document.getElementById('signin-btn');
                    if (btn) btn.addEventListener('click', () => openModal(true));
                    // Clear user-specific state
                    state.favorites = [];
                    state.reviews = {};
                    state.comparisons = [];
                }
            }
            // --- Usage Example ---
            // To add/remove a favorite:
            // state.favorites.push(toolId); await saveFavoritesToFirestore();
            // To add/edit a review:
            // state.reviews[toolId] = reviewText; await saveReviewsToFirestore();
            // To update comparison list:
            // state.comparisons = [...]; await saveComparisonsToFirestore();
            // --- INITIALIZATION ---

            // Lightweight hash routing helpers
            function getHashParams() {
                const raw = (location.hash || '').replace(/^#/, '');
                if (!raw) return new URLSearchParams('');
                return new URLSearchParams(raw.includes('=') ? raw : `domain=${raw}`);
            }

            function applyHashRoute() {
                try {
                    const params = getHashParams();
                    const tool = params.get('tool');
                    const domain = params.get('domain');
                    if (tool && typeof window.openToolByName === 'function') {
                        window.openToolByName(tool);
                        return;
                    }
                    if (domain) {
                        state.currentView = 'tools';
                        state.selectedDomain = decodeURIComponent(domain);
                    }
                } catch (e) { /* ignore */ }
            }

            // --- Popularity sorting helpers ---
            function normalizeKey(name) { return (name || '').toString().trim().toLowerCase(); }

            function buildMostPopularOrderMap(dbArray) {
                try {
                    const mp = (dbArray || []).find(d => (d.slug === 'most-popular' || /most\s*popular/i.test(d.name || '')));
                    if (!mp || !Array.isArray(mp.tools)) return {};
                    const base = 1_000_000; // very high baseline so MP always ranks top if no explicit counts
                    const step = 1_000;      // distance between neighbors
                    const map = {};
                    mp.tools.forEach((t, idx) => {
                        map[normalizeKey(t.name)] = base - idx * step;
                    });
                    return map;
                } catch { return {}; }
            }

            function buildFrequencyMap(dbArray) {
                const freq = {};
                try {
                    (dbArray || []).forEach(section => {
                        (section.tools || []).forEach(t => {
                            const k = normalizeKey(t.name);
                            freq[k] = (freq[k] || 0) + 1;
                        });
                    });
                } catch { /* ignore */ }
                return freq;
            }

            async function loadPopularityMap() {
                // Optional file: public/popularity.json { "tool name": usersCount }
                try {
                    const res = await fetch('public/popularity.json', { cache: 'no-store' });
                    if (res.ok) {
                        const data = await res.json();
                        return data && typeof data === 'object' ? data : {};
                    }
                } catch { /* file may not exist - that's okay */ }
                return {};
            }
            async function loadPopularityRanks() {
                try {
                    const res = await fetch('public/popularity_ranks.json', { cache: 'no-store' });
                    if (res.ok) {
                        const data = await res.json();
                        return data && typeof data === 'object' ? Object.fromEntries(Object.entries(data).map(([k,v])=>[String(k).toLowerCase(), v])) : {};
                    }
                } catch { /* optional */ }
                return {};
            }

            function getPopularityScore(tool, popMap, mpOrderMap, freqMap) {
                const key = normalizeKey(tool?.name);
                // Prefer explicit numeric fields on tool
                const direct = tool && (tool.users ?? tool.monthlyUsers ?? tool.popularity ?? tool.userCount);
                const directNum = Number(direct);
                if (!Number.isNaN(directNum) && directNum > 0) return directNum;
                // Otherwise external mapping
                const extNum = Number(popMap[key]);
                if (!Number.isNaN(extNum) && extNum > 0) return extNum;
                // Otherwise if listed in Most Popular, give order weight
                const mpNum = Number(mpOrderMap[key]);
                if (!Number.isNaN(mpNum) && mpNum > 0) return mpNum;
                // Fallback to frequency across sections
                const freq = Number(freqMap[key] || 0);
                if (!Number.isNaN(freq) && freq > 0) return freq;
                // Fallback
                return 0;
            }

            function sortDatabaseByPopularity(dbArray, popMap, mpOrderMap, freqMap) {
                if (!Array.isArray(dbArray)) return;
                dbArray.forEach(section => {
                    if (!Array.isArray(section.tools)) return;
                    section.tools.sort((a, b) => {
                        const aScore = getPopularityScore(a, popMap, mpOrderMap, freqMap);
                        const bScore = getPopularityScore(b, popMap, mpOrderMap, freqMap);
                        if (bScore !== aScore) return bScore - aScore; // higher first
                        // tie-breaker: alphabetical by name
                        const an = (a.name || '').toLowerCase();
                        const bn = (b.name || '').toLowerCase();
                        if (an < bn) return -1; if (an > bn) return 1; return 0;
                    });
                });
            }

            async function initialize() {
                try {
                    try { window.__TOOLS_READY = false; } catch(e) {}
                    const response = await fetch('public/tools.json', { cache: 'no-store' });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    db = await response.json();
                    // Optional: fetch slug alias map to normalize incoming sections
                    let slugAliases = {};
                    try {
                        const aliasRes = await fetch('data/domain-slug-aliases.json', { cache: 'no-store' });
                        if (aliasRes.ok) {
                            const obj = await aliasRes.json();
                            slugAliases = (obj && (obj.aliases || obj)) || {};
                        }
                    } catch {}
                    // Deduplicate sections by canonical slug to avoid duplicate tiles if a stale cached file or mixed sources appear
                    const toSlug = (s) => String(s||'').trim().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
                    if (Array.isArray(db)){
                        const bySlug = new Map();
                        for (const sec of db){
                            let slug = toSlug(sec?.slug || sec?.name || '');
                            if (slugAliases && typeof slugAliases[slug] === 'string') slug = toSlug(slugAliases[slug]);
                            const existing = bySlug.get(slug);
                            if (!existing){
                                // Ensure tools is an array
                                if (!Array.isArray(sec.tools)) sec.tools = [];
                                bySlug.set(slug, { ...sec, slug });
                            } else {
                                const tools = Array.isArray(sec.tools) ? sec.tools : [];
                                const existingTools = Array.isArray(existing.tools) ? existing.tools : [];
                                const names = new Set(existingTools.map(t => String(t?.name||'').toLowerCase()));
                                for (const t of tools){
                                    const k = String(t?.name||'').toLowerCase();
                                    if (k && !names.has(k)) { existingTools.push(t); names.add(k); }
                                }
                                existing.tools = existingTools;
                                bySlug.set(slug, existing);
                            }
                        }
                        db = Array.from(bySlug.values());
                    }
                    // Build quick lookup for tool -> domain
                    toolDomainMap = new Map();
                    if (Array.isArray(db)) {
                        for (const section of db) {
                            const slug = section?.slug || '';
                            const tools = Array.isArray(section?.tools) ? section.tools : [];
                            for (const t of tools) {
                                if (t && t.name) toolDomainMap.set(t.name, slug);
                            }
                        }
                    }
                    // Hard filter: exclude GitHub web/repo links except allowlisted tools
                    const allowGithubNames = new Set([
                        'github copilot' // keep Copilot even though it lives on github.com/features/copilot
                    ]);
                    const getHost = (url) => {
                        try {
                            return new URL(String(url || '')).hostname.replace(/^www\./, '').toLowerCase();
                        } catch {
                            return '';
                        }
                    };
                    const isGithubHost = (url) => getHost(url) === 'github.com';
                    const isNpmHost = (url) => getHost(url) === 'npmjs.com';
                    const norm = (s)=> String(s||'').trim().toLowerCase();
                    if (Array.isArray(db)) {
                        db.forEach(sec => {
                            if (!Array.isArray(sec.tools)) return;
                            const isGithubSection = String(sec.slug||'') === 'github-ai-projects';
                            sec.tools = sec.tools.filter(t => {
                                if (t?._commentedOut) return false;
                                if (isNpmHost(t?.link)) return false;
                                const nameOk = allowGithubNames.has(norm(t?.name));
                                // Allow GitHub links in the special GitHub section, but keep the policy elsewhere
                                if (isGithubSection) return true;
                                return nameOk || !isGithubHost(t?.link);
                            });
                        });
                    }
                    try { window.db = db; } catch (e) {}
                } catch (error) {
                    console.error("Could not load tool data:", error);
                    contentArea.innerHTML = `<div class="text-center text-red-500">Error: Could not load AI tool data. Please check the console.</div>`;
                    return;
                }
                // Sort tools by popularity if available
                popularityMap = await loadPopularityMap();
                popularityRanksMap = await loadPopularityRanks();
                const mostPopularOrder = buildMostPopularOrderMap(db);
                mostPopularOrderMap = mostPopularOrder;
                const frequencyMap = buildFrequencyMap(db);
                sortDatabaseByPopularity(db, popularityMap, mostPopularOrder, frequencyMap);
                
                // build search index
                setupFuse();

                // Auth state listener
                onAuthStateChanged(auth, (user) => {
                    updateAuthUI(user);
                });

                // Modal listeners
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
                authModal.addEventListener('click', (e) => { if (e.target === authModal) closeModal(); });
                toolDetailsModal.addEventListener('click', (e) => { if (e.target === toolDetailsModal) closeToolDetailsModal(); });
                modalSwitchBtn.addEventListener('click', () => openModal(!isLoginMode));
                authForm.addEventListener('submit', handleAuthSubmit);
                document.getElementById('google-signin-btn').addEventListener('click', handleGoogleSignIn);

                // Nav listeners
                document.getElementById('home-link').addEventListener('click', (e) => { e.preventDefault(); state.currentView = 'home'; state.searchQuery = ''; try { history.pushState('', document.title, window.location.pathname + window.location.search); } catch (e) {} render(); });
                document.getElementById('domains-link').addEventListener('click', (e) => { e.preventDefault(); state.currentView = 'home'; state.searchQuery = ''; render(); });
                document.getElementById('submit-link').addEventListener('click', (e) => { e.preventDefault(); state.currentView = 'submit'; render(); });
                document.getElementById('about-link').addEventListener('click', (e) => { e.preventDefault(); state.currentView = 'about'; render(); });

                // Keyboard shortcut: focus search with '/' on Home
                document.addEventListener('keydown', (ev) => {
                    if (ev.key === '/' && state.currentView === 'home') {
                        ev.preventDefault();
                        const sb = document.getElementById('search-bar-new');
                        if (sb) sb.focus();
                    }
                });

                // Apply initial hash route and listen for changes
                applyHashRoute();
                window.addEventListener('hashchange', () => { applyHashRoute(); render(); });

                render();
                // Mark tools/search UI ready after first successful render cycle
                try { window.__TOOLS_READY = true; } catch(e) {}
            }
            
            function setupTheme() {
                const themeToggleBtn = document.getElementById('theme-toggle');
                const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
                const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
                const htmlEl = document.documentElement;

                const applyTheme = (theme) => {
                    const isDark = theme === 'dark';
                    htmlEl.classList.toggle('dark', isDark);
                    if (themeToggleLightIcon) themeToggleLightIcon.classList.toggle('hidden', !isDark);
                    if (themeToggleDarkIcon) themeToggleDarkIcon.classList.toggle('hidden', isDark);
                };
                
                if (themeToggleBtn) {
                    themeToggleBtn.addEventListener('click', () => {
                        const newTheme = htmlEl.classList.contains('dark') ? 'light' : 'dark';
                        localStorage.setItem('theme', newTheme);
                        applyTheme(newTheme);
                        render(); // Re-render to apply all theme-dependent styles
                    });
                }

                const initialTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                applyTheme(initialTheme);
            }

            initialize();

            // Footer subscribe form handler
            (function setupFooterSubscribe(){
                const form = document.getElementById('footer-subscribe-form');
                if (!form) return;
                const emailInput = document.getElementById('footer-subscribe-email');
                const statusEl = document.getElementById('footer-subscribe-status');
                const btn = document.getElementById('footer-subscribe-btn');
                function setStatus(msg, ok=true){ if(statusEl){ statusEl.textContent = msg; statusEl.style.color = ok ? '#a7f3d0' : '#fecaca'; } }
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = (emailInput?.value || '').trim();
                    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { setStatus('Please enter a valid email address.', false); return; }
                    try {
                        btn.disabled = true; setStatus('Subscribing...');
                        // Serverless disabled; use mailto fallback
                        window.location.href = `mailto:hello@aitoolverse.ai?subject=Subscribe&body=${encodeURIComponent(email)}%20wants%20to%20subscribe.`;
                        setStatus('Thanks! You are on the list.', true);
                        form.reset();
                    } catch (err) {
                        setStatus('Could not subscribe right now.', false);
                    } finally {
                        btn.disabled = false;
                    }
                });
            })();
    });
    </script>
<!-- prompt modal will be loaded here (prompt.html) -->
<div id="prompt-html-root"></div>

<!-- prompt enhancer script (now referenced from public/) -->
<script src="./public/prompt-enhancer.js" defer></script>
<script>
    (function initBackgroundVideo(){
        try{
            const vid = document.getElementById('background-video');
            const source = document.getElementById('bg-video-source');
            if(!vid || !source) return;
            const url = new URL(window.location.href);
            const override = url.searchParams.get('bgmp4');
            if(override){ source.src = override; vid.load(); }
            // Slow down video by 40% total (playback rate = 0.6)
            vid.playbackRate = 0.6;
            const show = ()=>{ vid.style.opacity = '1'; };
            vid.addEventListener('loadeddata', show, { once: true });
            // Fallback reveal after a second in case readyState already good
            setTimeout(()=>{ if(vid.readyState >= 2) show(); }, 800);
        }catch(e){ /* ignore */ }
    })();
</script>
</body>
</html>
