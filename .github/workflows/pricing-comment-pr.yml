name: Pricing Audit Comment

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'public/tools.json'
      - 'data/pricing-overrides.json'
      - 'scripts/audit-pricing.mjs'

jobs:
  comment:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
      - name: Run audit (no fail)
        run: npm run audit:pricing
      - name: Build PR comment
        id: build
        run: |
          node -e "
          const fs=require('fs');
          const j=JSON.parse(fs.readFileSync('data/pricing-audit.json','utf8'));
          const anomalies=j.anomalies||[];
          const counts=j.counts||{};
          const lines=[];
          lines.push('### Pricing Audit Summary');
          lines.push('');
          lines.push('Counts:');
          Object.keys(counts).forEach(k=>lines.push('- ' + k + ': ' + counts[k]));
          lines.push('');
          if (anomalies.length){
            lines.push('Anomalies: ' + anomalies.length);
            const sample=anomalies.slice(0,10).map(a=>'- [' + a.section + '] ' + a.tool + ' â€” ' + a.reason + ' (' + (a.labels||[]).join(', ') + ')');
            lines.push(...sample);
            lines.push('');
            lines.push('Approve conflicts here: actions -> Pricing Approval');
          } else {
            lines.push('No anomalies detected.');
          }
          fs.writeFileSync(process.env.GITHUB_OUTPUT, 'body<<EOF\\n' + lines.join('\\n') + '\\nEOF\\n');
          "
      - name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pricing-audit
          message: ${{ steps.build.outputs.body }}