name: Archive Non-Product Tools

on:
  workflow_dispatch:
    inputs:
      apply:
        description: 'Apply changes (set to true to write files). Default is dry-run.'
        required: false
        default: 'false'
      whitelist:
        description: 'Optional path to whitelist JSON (relative to repo root).'
        required: false
        default: 'data/whitelist.json'
      verbose:
        description: 'Verbose logging.'
        required: false
        default: 'false'
      restore_all:
        description: 'Restore all archived tools instead of archiving. (true/false)'
        required: false
        default: 'false'
      restore_list:
        description: 'Comma separated tool names to restore. Ignored if restore_all=true.'
        required: false
        default: ''

jobs:
  archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install (if needed)
        run: |
          if [ -f package.json ]; then npm ci --ignore-scripts; fi

      - name: Run Archive (dry-run or apply)
        id: run_archive
        run: |
          CMD="node scripts/archive-non-products.mjs --whitelist ${{ github.event.inputs.whitelist }}"
          if [ "${{ github.event.inputs.verbose }}" = "true" ]; then CMD="$CMD --verbose"; fi
          if [ "${{ github.event.inputs.restore_all }}" = "true" ]; then
            CMD="$CMD --restore-all"
          elif [ -n "${{ github.event.inputs.restore_list }}" ]; then
            CMD="$CMD --restore '${{ github.event.inputs.restore_list }}'"
          else
            if [ "${{ github.event.inputs.apply }}" != "true" ]; then
              CMD="$CMD --dry-run"
            fi
          fi
          echo "Running: $CMD"
          eval $CMD

      - name: Commit and Push (if apply)
        if: ${{ github.event.inputs.apply == 'true' }}
        run: |
          git config user.name 'github-actions'
            git config user.email 'actions@github.com'
            if git diff --quiet; then
              echo 'No changes to commit.'
            else
              git add public/tools.json public/non_product_archive.json || true
              git commit -m 'chore: archive non-product tools (CI)' || echo 'Nothing to commit'
              git push
            fi
