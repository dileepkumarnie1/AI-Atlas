name: Update Popularity

on:
  schedule:
    - cron: '17 3 * * *'  # Daily at 03:17 UTC
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run updater
        run: |
          npm ci --ignore-scripts --no-audit --no-fund || echo "No lockfile; continuing"
          node ./scripts/update-popularity.mjs

      - name: Commit and push changes
        id: commit_push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add public/popularity.json public/popularity_ranks.json data/popularity_raw.json
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "pop_changed=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore(popularity): daily refresh"
            git push
            echo "pop_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Email Top 30 (after update)
        if: steps.commit_push.outputs.pop_changed == 'true'
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
        run: node ./scripts/email-top-popularity.mjs
