name: Discover New Tools

on:
  schedule:
    - cron: '30 1 * * *'  # Daily at 01:30 UTC (07:00 IST)
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  discover:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm ci || npm i

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install ML dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f ml/requirements.txt ]; then
            python -m pip install -r ml/requirements.txt
          fi

      - name: Discover tools
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
          GOOGLE_SAFEBROWSING_API_KEY: ${{ secrets.GOOGLE_SAFEBROWSING_API_KEY }}
          PRODUCT_HUNT_TOKEN: ${{ secrets['PRODUCT_HUNT_TOKEN'] }}
          BUILTWITH_API_KEY: ${{ secrets['BUILTWITH_API_KEY'] }}
          SIMILARTECH_API_KEY: ${{ secrets['SIMILARTECH_API_KEY'] }}
          CRUNCHBASE_API_KEY: ${{ secrets['CRUNCHBASE_API_KEY'] }}
          # Prefer a Secret if provided; else fall back to Actions Variable
          RELIABILITY_STRICT: ${{ secrets.RELIABILITY_STRICT != '' && secrets.RELIABILITY_STRICT || vars.RELIABILITY_STRICT || 'true' }}
          GLOBAL_MAX_NEW_TOOLS: 90
          # Allow non-.ai domains while keeping quality filters in code
          DISCOVERY_DOMAINS_AI_ONLY: false
          DISCOVERY_MIN_PER_DOMAIN: 6
          # Relax parity for selected domains (soft parity) while .ai-only remains enforced
          DISCOVERY_IMAGE_GENERATION_AIXPLORIA_STRICT: false
          DISCOVERY_LANGUAGE_CHAT_AIXPLORIA_STRICT: false
          DISCOVERY_CODE_ASSISTANCE_AIXPLORIA_STRICT: false
          # Approval flow config (optional): base URL for Netlify function and signing key
          APPROVAL_BASE_URL: ${{ vars.APPROVAL_BASE_URL }}
          ADMIN_APPROVAL_SIGNING_KEY: ${{ secrets.ADMIN_APPROVAL_SIGNING_KEY }}
          # Firebase service account (JSON string). Enables creation of pending docs for approval links.
          FIREBASE_SERVICE_ACCOUNT_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}
        run: node ./scripts/discover-tools.mjs

      - name: Quarantine npm registry entries
        run: node ./scripts/flag-npm-tools.mjs

      - name: Create branch for changes
        id: create_branch
        run: |
          CHANGED=$(git status --porcelain)
          if [ -z "$CHANGED" ]; then echo "No changes"; exit 0; fi
          BR=ci/discovery-$(date +%Y%m%d%H%M%S)
          git checkout -b $BR
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add public/tools.json data/discovery_log.json data/pending-tools.json
          git commit -m "chore(discovery): new tools added"
          git push --set-upstream origin $BR
          echo "branch=$BR" >> $GITHUB_OUTPUT

      - name: Open PR
        if: ${{ steps.create_branch.outputs.branch != '' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(discovery): new tools added"
          branch: ${{ steps.create_branch.outputs.branch }}
          title: "Automated: discovered new tools"
          body: |
            Automated discovery added tools. Please review descriptions and placement.
          base: main
